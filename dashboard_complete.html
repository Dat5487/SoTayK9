<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 Management Dashboard - Complete</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Sửa data table để hiển thị đầy đủ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: visible;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Responsive cho dog management table */
        .data-table td:nth-child(1) {
            max-width: 80px;
        }

        .data-table td:nth-child(2) {
            max-width: 70px;
        }

        .data-table td:nth-child(3) {
            max-width: 90px;
        }

        .data-table td:nth-child(4) {
            max-width: 100px;
        }

        .data-table td:nth-child(5) {
            max-width: 80px;
        }

        .data-table td:nth-child(6) {
            min-width: 120px;
        }

        /* Operation columns - half width */
        .data-table .operation-days {
            width: 3.5%;
            max-width: 50px;
        }

        .data-table .operation-results {
            width: 6%;
            max-width: 80px;
        }

        /* Control panels responsive */
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        /* Button sizing trong table */
        .data-table .btn {
            font-size: 11px;
            padding: 3px 8px;
            margin: 1px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .dashboard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Login Form Styles */
        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            margin: 50px auto;
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-full-width {
            width: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
        }

        /* Dashboard Main Styles */
        .dashboard-main {
            display: none;
        }

        .dashboard-main.active {
            display: block;
        }

        .dashboard-nav {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-nav h2 {
            color: #333;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .role-admin {
            background-color: #4CAF50;
            color: white;
        }

        .role-manager {
            background-color: #FF9800;
            color: white;
        }

        .role-trainer {
            background-color: #2196F3;
            color: white;
        }

        /* SỬA .control-panels THÀNH LAYOUT VERTICAL */
        .control-panels {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            min-height: 300px;
        }

        /* Thêm hiệu ứng hover cho control panels */
        .control-panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .control-panel h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Modal Styles - SỬA QUAN TRỌNG */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        /* Status indicators */
        .status-indicator {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background-color: #4CAF50;
            color: white;
        }

        .status-pending {
            background-color: #FF9800;
            color: white;
        }

        .status-inactive {
            background-color: #f44336;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 10px;
            }

            .control-panels {
                grid-template-columns: 1fr;
            }

            .dashboard-nav {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        /* Web Control Section */
        .web-control-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .web-control-section h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .web-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .web-link-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-decoration: none;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .web-link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            color: white;
            text-decoration: none;
        }

        .web-link-card h4 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .web-link-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Checkbox styles */
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            margin-bottom: 0;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 3px;
            margin-right: 8px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked+.checkmark {
            background-color: #007bff;
            border-color: #007bff;
        }

        .checkbox-label input[type="checkbox"]:checked+.checkmark::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .checkbox-label:hover .checkmark {
            border-color: #007bff;
        }

        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }
    </style>
    
    <!-- jQuery and Select2 CSS and JS for enhanced dropdowns -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<body>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>🐕 K9 MANAGEMENT SYSTEM</h1>
            <p>Hệ Thống Quản Lý Chó Nghiệp Vụ Hải Quan</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="login-container">
            <h2>🔐 Đăng Nhập Dashboard</h2>
            <form id="dashboardLoginForm">
                <div class="form-group">
                    <label for="adminUsername">Tên đăng nhập:</label>
                    <input type="text" id="adminUsername" placeholder="Nhập tên đăng nhập" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Mật khẩu:</label>
                    <input type="password" id="adminPassword" placeholder="Nhập mật khẩu" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="rememberMe" checked>
                        <span class="checkmark"></span>
                        Ghi nhớ đăng nhập (7 ngày)
                    </label>
                </div>
                <button type="submit" class="btn btn-full-width">Đăng Nhập</button>
            </form>
        </div>

        <!-- Dashboard Main -->
        <div id="dashboardMain" class="dashboard-main">
            <!-- Navigation -->
            <div class="dashboard-nav">
                <h2>Dashboard Quản Lý</h2>
                <div class="user-info">
                    <span id="currentUserDisplay">Admin User</span>
                    <span id="currentRoleDisplay" class="role-badge role-admin">ADMIN</span>
                    <button class="btn btn-danger" onclick="logoutDashboard()">Đăng Xuất</button>
                </div>
            </div>

            <!-- Control Panels -->
            <div class="control-panels">
                <!-- User Management Panel -->
                <div class="control-panel">
                    <h3>👥 QUẢN LÝ NGƯỜI DÙNG</h3>
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="openCreateUserModal()">Tạo User</button>
                        <button class="btn btn-info" onclick="loadUserList()">Danh Sách</button>
                        <button class="btn btn-warning" onclick="loadAssignmentList()">Phân Công</button>
                    </div>
                    <div id="userListContainer"></div>
                </div>

                <!-- Dog Management Panel -->
                <div class="control-panel">
                    <h3>🐕 QUẢN LÝ CHÓ NGHIỆP VỤ</h3>
                    <div class="control-buttons">
                        <button class="btn btn-success" onclick="openCreateDogModal()">Thêm Chó</button>
                        <button class="btn btn-info" onclick="loadDogList()">Danh Sách</button>
                        <button class="btn btn-warning" onclick="viewDogStatus()">Trạng Thái</button>
                    </div>
                    <div id="dogListContainer"></div>
                </div>

                <!-- Journal Management Panel -->
                <div class="control-panel">
                    <h3>📋 QUẢN LÝ NHẬT KÝ</h3>
                    <div class="control-buttons">
                        <button class="btn btn-info" onclick="loadJournalList()">Tất Cả Nhật Ký</button>
                        <button class="btn btn-warning" onclick="loadPendingJournals()">Chờ Duyệt</button>
                        <button class="btn btn-success" onclick="loadApprovedJournals()">Đã Duyệt</button>
                    </div>
                    <div id="journalListContainer"></div>
                </div>

                <!-- Training Data Management Panel -->
                <div class="control-panel">
                    <h3>📊 BÁO CÁO HUẤN LUYỆN VÀ TÁC NGHIỆP</h3>
                    <div class="control-buttons">
                        <button class="btn btn-info" onclick="loadTrainingDataTable()">Tải Báo Cáo</button>
                        <button class="btn btn-success" onclick="exportTrainingDataToPDF()">Xuất PDF</button>
                        <button class="btn btn-warning" onclick="refreshTrainingData()">Làm Mới</button>
                    </div>
                    <div id="trainingDataContainer"></div>
                </div>
            </div>

            <!-- Web Control Section -->
            <div class="web-control-section">
                <h3>🌐 ĐIỀU KHIỂN WEB APPLICATION</h3>
                <div class="web-links">
                    <a href="#" class="web-link-card" onclick="openWebForRole('ADMIN')">
                        <h4>👑 Admin Access</h4>
                        <p>Full quyền quản trị</p>
                    </a>
                    <a href="#" class="web-link-card" onclick="openWebForRole('TRAINER')">
                        <h4>🎯 Trainer Access</h4>
                        <p>Chỉ chó được gán</p>
                    </a>
                    <a href="#" class="web-link-card" onclick="openWebForRole('MANAGER')">
                        <h4>📊 Manager Access</h4>
                        <p>Duyệt nhật ký</p>
                    </a>
                    <a href="index.html" class="web-link-card" target="_blank">
                        <h4>🔗 Direct Web</h4>
                        <p>Truy cập trực tiếp</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal - SỬA QUAN TRỌNG -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Tạo Người Dùng Mới</h3>
                <span class="close" onclick="forceCloseUserModal()">&times;</span>
            </div>
            <form id="userForm" style="padding-bottom: 20px;">
                <div class="form-group">
                    <label for="userName">Họ và tên:</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userUsername">Tên đăng nhập:</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Mật khẩu:</label>
                    <input type="password" id="userPassword" required>
                    <small id="passwordHelpText" style="color: #666; font-size: 12px;">Bắt buộc cho tài khoản mới</small>
                </div>
                <div class="form-group">
                    <label for="userRole">Vai trò:</label>
                    <select id="userRole" required>
                        <option value="">Chọn vai trò</option>
                        <option value="TRAINER">Huấn luyện viên</option>
                        <option value="MANAGER">Quản lý</option>
                        <option value="ADMIN">Quản trị viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" placeholder="Nhập địa chỉ email">
                </div>
                <div class="form-group">
                    <label for="userPhone">Số điện thoại:</label>
                    <input type="tel" id="userPhone" placeholder="Nhập số điện thoại">
                </div>
                <div class="form-group">
                    <label for="userDepartment">Phòng ban:</label>
                    <input type="text" id="userDepartment" placeholder="Nhập phòng ban">
                </div>
                <div class="form-group">
                    <label for="userStatus">Trạng thái:</label>
                    <select id="userStatus">
                        <option value="ACTIVE">Hoạt động</option>
                        <option value="INACTIVE">Không hoạt động</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userDogs">Chó được phân công:</label>
                    <select id="userDogs" multiple style="height: 100px;">
                        <!-- Sẽ được load động từ dogs data -->
                    </select>
                    <small>Giữ Ctrl để chọn nhiều chó</small>
                </div>
                <div class="form-group">
                    <label for="userSignature">Chữ ký:</label>
                    <input type="file" id="userSignature" accept="image/*" onchange="previewSignature(this)">
                    <small>Chọn file ảnh chữ ký (PNG, JPG, JPEG)</small>
                    <div id="signaturePreview" style="margin-top: 10px; display: none;">
                        <img id="signaturePreviewImg"
                            style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 4px;">
                        <div style="margin-top: 5px;">
                            <button type="button" class="btn btn-danger" onclick="clearSignature()"
                                style="font-size: 12px; padding: 4px 8px;">Xóa chữ ký</button>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-success btn-full-width">Lưu</button>
            </form>
        </div>
    </div>

    <!-- Dog Modal -->
    <div id="dogModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="dogModalTitle">Thêm Chó Nghiệp Vụ Mới</h3>
                <span class="close" onclick="closeModal('dogModal')">&times;</span>
            </div>
            <form id="dogForm">
                <!-- SỬA: FORM THEO CHUẨN WEB -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Cột trái - Ảnh và thông tin cơ bản -->
                    <div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img id="dog_modal_image" src="images/default_dog.jpg" alt="Ảnh CNV"
                                style="width: 150px; height: 150px; border-radius: 10px; border: 2px solid #ddd;">
                            <h4 style="margin: 10px 0; color: #333;">SƠ YẾU LÝ LỊCH</h4>
                        </div>

                        <div class="form-group">
                            <label for="dogName">1. Tên CNV:</label>
                            <input type="text" id="dogName" required>
                        </div>
                        <div class="form-group">
                            <label for="dogChipId">2. Số hiệu:</label>
                            <input type="text" id="dogChipId" required>
                        </div>
                        <div class="form-group">
                            <label for="dogBirthDate">3. Ngày sinh:</label>
                            <input type="date" id="dogBirthDate">
                        </div>
                        <div class="form-group">
                            <label for="dogBirthPlace">4. Nơi sinh:</label>
                            <input type="text" id="dogBirthPlace">
                        </div>
                        <div class="form-group">
                            <label for="dogBreed">5. Giống CNV:</label>
                            <select id="dogBreed" required>
                                <option value="">Chọn giống</option>
                                <option value="German Shepherd">German Shepherd</option>
                                <option value="Belgian Malinois">Belgian Malinois</option>
                                <option value="Labrador">Labrador</option>
                                <option value="Golden Retriever">Golden Retriever</option>
                                <option value="Rottweiler">Rottweiler</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dogGender">6. Tính biệt:</label>
                            <select id="dogGender">
                                <option value="">Chọn giới tính</option>
                                <option value="Đực">Đực</option>
                                <option value="Cái">Cái</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cột phải - Thông tin bổ sung -->
                    <div>
                        <div class="form-group">
                            <label for="dogFeatures">7. Đặc điểm ngoại hình:</label>
                            <textarea id="dogFeatures" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dogFurColor">8. Màu lông:</label>
                            <input type="text" id="dogFurColor">
                        </div>
                        <div class="form-group">
                            <label for="dogValue">9. Số giá trị:</label>
                            <input type="text" id="dogValue">
                        </div>

                        <hr style="margin: 20px 0;">
                        <h4 style="color: #333; margin-bottom: 15px;">DÒNG HỌ</h4>

                        <div class="form-group">
                            <label for="dogFatherName">1. Tên bố:</label>
                            <input type="text" id="dogFatherName">
                        </div>
                        <div class="form-group">
                            <label for="dogFatherBirth">2. Ngày sinh:</label>
                            <input type="date" id="dogFatherBirth">
                        </div>
                        <div class="form-group">
                            <label for="dogFatherPlace">3. Nơi sinh:</label>
                            <input type="text" id="dogFatherPlace">
                        </div>
                        <div class="form-group">
                            <label for="dogFatherBreed">4. Giống:</label>
                            <input type="text" id="dogFatherBreed">
                        </div>
                        <div class="form-group">
                            <label for="dogFatherFeatures">5. Đặc điểm ngoại hình:</label>
                            <textarea id="dogFatherFeatures" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <hr style="margin: 20px 0;">
                <!-- SỬA: THÊM PHẦN HUẤN LUYỆN VIÊN QUẢN LÝ -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <h4 style="color: #333;">HUẤN LUYỆN VIÊN QUẢN LÝ</h4>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="dogTrainer">Huấn luyện viên phụ trách:</label>
                        <select id="dogTrainer" onchange="updateTrainerInfo()">
                            <option value="">Chưa phân công</option>
                            <!-- Sẽ được load động từ users data -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dogStatus">Trạng thái hoạt động:</label>
                        <select id="dogStatus" required>
                            <option value="ACTIVE">Hoạt động</option>
                            <option value="TRAINING">Đang huấn luyện</option>
                            <option value="INACTIVE">Nghỉ ngơi</option>
                        </select>
                    </div>
                </div>

                <!-- SỬA: 6 TRƯỜNG THÔNG TIN HLV -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="hlvTen">1. Họ và tên HLV:</label>
                        <input type="text" id="hlvTen" readonly>
                    </div>
                    <div class="form-group">
                        <label for="hlvNgaysinh">2. Ngày tháng năm sinh HLV:</label>
                        <input type="date" id="hlvNgaysinh">
                    </div>
                    <div class="form-group">
                        <label for="hlvCapbac">3. Cấp bậc:</label>
                        <input type="text" id="hlvCapbac">
                    </div>
                    <div class="form-group">
                        <label for="hlvChucvu">4. Chức vụ:</label>
                        <input type="text" id="hlvChucvu">
                    </div>
                    <div class="form-group">
                        <label for="hlvDonvi">5. Đơn vị:</label>
                        <input type="text" id="hlvDonvi">
                    </div>
                    <div class="form-group">
                        <label for="hlvDaotao">6. Qua trường đào tạo:</label>
                        <input type="text" id="hlvDaotao">
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-full-width" style="margin-top: 20px;">Lưu Hồ Sơ
                    CNV</button>
            </form>
        </div>
    </div>

    <script>
        // =============================================================================
        // DATE FORMATTING UTILITY FUNCTIONS
        // =============================================================================

        /**
         * Format date to dd/mm/yyyy format
         * @param {Date|string} date - Date object or ISO string
         * @param {boolean} includeTime - Whether to include time in the format
         * @returns {string} Formatted date string
         */
        function formatDateToDDMMYYYY(date, includeTime = false) {
            if (!date) return 'N/A';
            
            const dateObj = typeof date === 'string' ? new Date(date) : date;
            
            if (isNaN(dateObj.getTime())) return 'N/A';
            
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            if (includeTime) {
                const hours = String(dateObj.getHours()).padStart(2, '0');
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                const seconds = String(dateObj.getSeconds()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
            }
            
            return `${day}/${month}/${year}`;
        }

        /**
         * Get current date in dd/mm/yyyy format
         * @returns {string} Current date formatted as dd/mm/yyyy
         */
        function getCurrentDateDDMMYYYY() {
            return formatDateToDDMMYYYY(new Date());
        }

        // Global variables
        let currentDashboardUser = null;
        let currentDashboardRole = 'GUEST';
        let users = [];
        let dogs = [];
        let editingUserId = null;
        let editingDogId = null;
        let selectedSignatureFile = null;

        // API Base URL
        const API_BASE_URL = window.location.origin;

        // Signature Preview Functions
        function previewSignature(input) {
            const file = input.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Vui lòng chọn file ảnh hợp lệ (PNG, JPG, JPEG)');
                    input.value = '';
                    return;
                }

                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('File ảnh quá lớn. Vui lòng chọn file nhỏ hơn 2MB');
                    input.value = '';
                    return;
                }

                selectedSignatureFile = file;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewImg = document.getElementById('signaturePreviewImg');
                    const previewDiv = document.getElementById('signaturePreview');

                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearSignature() {
            const input = document.getElementById('userSignature');
            const previewDiv = document.getElementById('signaturePreview');

            input.value = '';
            previewDiv.style.display = 'none';
            selectedSignatureFile = null;
        }

        function loadExistingSignature(signaturePath) {
            if (signaturePath) {
                const previewImg = document.getElementById('signaturePreviewImg');
                const previewDiv = document.getElementById('signaturePreview');

                previewImg.src = `signatures/${signaturePath}`;
                previewDiv.style.display = 'block';
            }
        }

        async function uploadSignatureFile(file) {
            try {
                const formData = new FormData();
                formData.append('signature', file);

                const response = await fetch(`${API_BASE_URL}/api/upload-signature`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    return result.filename;
                } else {
                    console.error('Upload error:', result.error);
                    return null;
                }
            } catch (error) {
                console.error('Upload error:', error);
                return null;
            }
        }

        // Session Management
        const SESSION_STORAGE_KEY = 'k9_session_token';
        const USER_STORAGE_KEY = 'k9_current_user';

        // Session Management Functions
        // Enhanced Session Management Functions
        function saveSession(sessionToken, userData, rememberMe = false) {
            try {
                if (rememberMe && sessionToken) {
                    // TODO: Save to database for persistent sessions
                    // console.log('✅ Session saved to database (persistent)');
                } else if (sessionToken) {
                    // Save to sessionStorage for temporary sessions
                    sessionStorage.setItem(SESSION_STORAGE_KEY, sessionToken);
                    sessionStorage.setItem(USER_STORAGE_KEY, JSON.stringify(userData));
                    // console.log('✅ Session saved to sessionStorage (temporary)');
                }
            } catch (error) {
                console.error('Error saving session:', error);
            }
        }

        function getSessionToken() {
            // TODO: Check database first (persistent sessions), then sessionStorage
            return sessionStorage.getItem(SESSION_STORAGE_KEY);
        }

        function getCurrentUser() {
            try {
                // TODO: Check database first (persistent sessions), then sessionStorage
                const userData = sessionStorage.getItem(USER_STORAGE_KEY);
                return userData ? JSON.parse(userData) : null;
            } catch (error) {
                console.error('Error parsing user data:', error);
                return null;
            }
        }

        function clearSession() {
            try {
                // TODO: Clear from database
                sessionStorage.removeItem(SESSION_STORAGE_KEY);
                sessionStorage.removeItem(USER_STORAGE_KEY);
                // console.log('✅ Session cleared');
            } catch (error) {
                console.error('Error clearing session:', error);
            }
        }

        async function validateSession() {
            const sessionToken = getSessionToken();
            if (!sessionToken) {
                // console.log('❌ No session token found');
                return null;
            }

            try {
                // console.log('🔍 Validating session token...');
                const response = await fetch(`${API_BASE_URL}/api/auth/validate-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_token: sessionToken
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // console.log('✅ Session validation successful');
                    // Update stored user data with fresh data from server
                    // TODO: Check database for persistent session
                    const isPersistent = false;
                    saveSession(sessionToken, result.data, isPersistent);
                    return result.data;
                } else {
                    // console.log('❌ Session validation failed:', result.error);
                    clearSession();
                    return null;
                }
            } catch (error) {
                console.error('❌ Session validation error:', error);
                clearSession();
                return null;
            }
        }

        async function logoutUser() {
            const sessionToken = getSessionToken();
            if (sessionToken) {
                try {
                    await fetch(`${API_BASE_URL}/api/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_token: sessionToken
                        })
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            clearSession();
            showLoginForm();
        }

        // API Functions
        async function fetchUsersFromAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users`);
                const result = await response.json();
                if (result.success) {
                    return result.data;
                } else {
                    console.error('Failed to fetch users:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching users from API:', error);
                return [];
            }
        }

        async function fetchDogsFromAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/dogs`);
                const result = await response.json();
                if (result.success) {
                    return result.data;
                } else {
                    console.error('Failed to fetch dogs:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching dogs from API:', error);
                return [];
            }
        }

        async function createUserViaAPI(userData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error creating user via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function updateUserViaAPI(userId, userData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error updating user via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function deleteUserViaAPI(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error deleting user via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function createDogViaAPI(dogData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/dogs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dogData)
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error creating dog via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function updateDogViaAPI(dogId, dogData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/dogs/${dogId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dogData)
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error updating dog via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function deleteDogViaAPI(dogId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/dogs/${dogId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error deleting dog via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function authenticateUserViaAPI(username, password, rememberMe = false) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        remember_me: rememberMe
                    })
                });
                const result = await response.json();

                if (result.success && result.session_token) {
                    // Save session if remember_me is true
                    saveSession(result.session_token, result.data, rememberMe);
                }

                return result;
            } catch (error) {
                console.error('Error authenticating user via API:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Initialize data from API (no localStorage fallback)
        async function initializeData() {
            // console.log('🔄 Initializing data from API...');

            try {
                // Try to fetch from API first
                const apiUsers = await fetchUsersFromAPI();
                const apiDogs = await fetchDogsFromAPI();

                if (apiUsers.length > 0 || apiDogs.length > 0) {
                    // console.log('✅ Data loaded from database API');
                    users = apiUsers;
                    dogs = apiDogs;
                    return;
                }
            } catch (error) {
                console.error('❌ API not available:', error);
            }

            // No fallback - use empty arrays
            // console.log('⚠️ Using empty data arrays');
            users = [];
            dogs = [];
        }


        // Enhanced initialization with better session handling
        document.addEventListener('DOMContentLoaded', async function () {
            // console.log('🚀 Initializing dashboard...');

            await initializeData();

            // Check for existing session
            // console.log('🔍 Checking for existing session...');
            const sessionUser = await validateSession();

            if (sessionUser) {
                // console.log('✅ Valid session found, auto-login');
                currentDashboardUser = sessionUser;
                currentDashboardRole = sessionUser.role;

                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('dashboardMain').classList.add('active');
                document.getElementById('currentUserDisplay').textContent = sessionUser.name;
                document.getElementById('currentRoleDisplay').textContent = sessionUser.role;
                document.getElementById('currentRoleDisplay').className =
                    `role-badge role-${sessionUser.role.toLowerCase()}`;

                await loadUserList();
                await loadDogList();
                loadJournalList();
                loadTrainingDataTable();

                // Show welcome back message
                showNotification(`Chào mừng trở lại, ${sessionUser.name}!`, 'success');
            } else {
                // console.log('❌ No valid session found, showing login form');
            }

            // Set up event listeners
            const loginForm = document.getElementById('dashboardLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', dashboardLogin);
            }

            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', submitUserForm);
            }

            const dogForm = document.getElementById('dogForm');
            if (dogForm) {
                dogForm.addEventListener('submit', submitDogForm);
            }

            // console.log('✅ Dashboard initialization completed');
        });

        // Enhanced Dashboard login with better session handling
        async function dashboardLogin(event) {
            event.preventDefault();

            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Đang đăng nhập...';
            submitBtn.disabled = true;

            try {
                // console.log(`🔐 Attempting login for user: ${username} (remember: ${rememberMe})`);

                // Try API authentication first
                const apiResult = await authenticateUserViaAPI(username, password, rememberMe);
                let user = null;

                if (apiResult.success) {
                    user = apiResult.data;
                    // console.log('✅ API authentication successful');
                } else {
                    // Fallback to local authentication
                    // console.log('⚠️ API authentication failed, trying local authentication');
                    user = users.find(u => u.username === username && u.password === password);

                    // Special case: Fix admin password issue
                    if (!user && username === 'admin' && password === 'admin') {
                        // console.log('🔧 Fixing admin password issue...');
                        user = users.find(u => u.username === 'admin');
                        if (user) {
                            user.password = 'admin'; // Fix the password
                            // console.log('✅ Admin password fixed in memory');
                        }
                    }

                    // For local authentication, also save to session storage
                    if (user) {
                        saveSession(null, user, rememberMe);
                    }
                }

                if (user) {
                    currentDashboardUser = user;
                    currentDashboardRole = user.role;

                    // Hide login form and show dashboard
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('dashboardMain').classList.add('active');
                    document.getElementById('currentUserDisplay').textContent = user.name;
                    document.getElementById('currentRoleDisplay').textContent = user.role;
                    document.getElementById('currentRoleDisplay').className =
                        `role-badge role-${user.role.toLowerCase()}`;

                    // Load dashboard data
                    await loadUserList();
                    await loadDogList();
                    loadJournalList();
                    loadTrainingDataTable();

                    // Show success message
                    showNotification(`Chào mừng ${user.name}! Đăng nhập thành công.`, 'success');

                    // console.log(`✅ Login successful for ${user.name} (${user.role})`);
                } else {
                    alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    // console.log('❌ Login failed - invalid credentials');
                }
            } catch (error) {
                console.error('❌ Login error:', error);
                alert('Có lỗi xảy ra khi đăng nhập! Vui lòng thử lại.');
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Logout dashboard
        async function logoutDashboard() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                await logoutUser();
                currentDashboardUser = null;
                currentDashboardRole = 'GUEST';

                // Reset forms
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
                document.getElementById('rememberMe').checked = false;
            }
        }

        // SỬA QUAN TRỌNG: Modal functions
        function forceCloseUserModal() {
            const modal = document.getElementById('userModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset form
                const form = document.getElementById('userForm');
                if (form) {
                    form.reset();
                }
                editingUserId = null;
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // SỬA: Load danh sách chó động cho user modal + FORCE REFRESH
        async function loadDogOptionsForUser() {
            const dogSelect = document.getElementById('userDogs');
            if (!dogSelect) return;

            dogSelect.innerHTML = '<option value="">Đang tải...</option>';

            try {
                // Load dogs from database API
                const response = await fetch(`${API_BASE_URL}/api/dogs`);
                const result = await response.json();

                if (result.success) {
                    dogSelect.innerHTML = '';

                    // Populate dropdown with dogs from database
                    result.data.forEach(dog => {
                        const option = document.createElement('option');
                        option.value = dog.name;
                        option.textContent = dog.name;
                        dogSelect.appendChild(option);
                    });

                    // console.log('✅ Loaded ' + result.data.length + ' dogs from database for user assignment');
                } else {
                    throw new Error(result.error || 'Failed to load dogs');
                }
            } catch (error) {
                console.error('❌ Error loading dogs for user assignment:', error);
                dogSelect.innerHTML = '<option value="">Lỗi tải dữ liệu</option>';

                // No fallback - show error
                console.error('❌ Failed to load dogs from database');
            }
        }


        // User Management Functions
        function openCreateUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Tạo Người Dùng Mới';
            document.getElementById('userName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').placeholder = 'Nhập mật khẩu';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordHelpText').textContent = 'Bắt buộc cho tài khoản mới';
            document.getElementById('userRole').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userDepartment').value = '';
            document.getElementById('userStatus').value = 'ACTIVE';
            document.getElementById('userSignature').value = '';

            // Clear signature preview
            clearSignature();

            // SỬA: FORCE Load danh sách chó động từ dogs data mới nhất
            loadDogOptionsForUser();
            document.getElementById('userModal').style.display = 'block';
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                editingUserId = userId;
                document.getElementById('userModalTitle').textContent = 'Chỉnh Sửa Người Dùng';
                document.getElementById('userName').value = user.name;
                document.getElementById('userUsername').value = user.username;
                // SỬA: Don't populate password field when editing - leave it blank so user can choose to change or not
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').placeholder = 'Để trống nếu không muốn thay đổi mật khẩu';
                document.getElementById('userPassword').required = false;
                document.getElementById('passwordHelpText').textContent = 'Để trống nếu không muốn thay đổi mật khẩu';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userDepartment').value = user.department || '';
                document.getElementById('userStatus').value = user.status || 'ACTIVE';
                document.getElementById('userSignature').value = '';

                // Load existing signature if available
                loadExistingSignature(user.signature);

                // SỬA: FORCE Load danh sách chó và set selection
                loadDogOptionsForUser();
                setTimeout(() => {
                    const dogSelect = document.getElementById('userDogs');
                    if (dogSelect && user.assignedDogs) {
                        for (let option of dogSelect.options) {
                            option.selected = user.assignedDogs.includes(option.value);
                        }
                    }
                }, 500); // Increased timeout to ensure async loading completes

                document.getElementById('userModal').style.display = 'block';
            }
        }

        // SỬA QUAN TRỌNG: Submit user form với FORCE CLOSE
        async function submitUserForm(event) {
            event.preventDefault();
            event.stopPropagation();

            try {
                let signaturePath = null;

                // Upload signature file if selected
                if (selectedSignatureFile) {
                    signaturePath = await uploadSignatureFile(selectedSignatureFile);
                    if (!signaturePath) {
                        alert('Lỗi khi tải lên file chữ ký!');
                        return;
                    }
                }

                const userData = {
                    name: document.getElementById('userName').value,
                    username: document.getElementById('userUsername').value,
                    role: document.getElementById('userRole').value,
                    email: document.getElementById('userEmail').value,
                    phone: document.getElementById('userPhone').value,
                    department: document.getElementById('userDepartment').value,
                    status: document.getElementById('userStatus').value,
                    assignedDogs: Array.from(document.getElementById('userDogs').selectedOptions).map(option =>
                        option.value)
                };

                // SỬA: Only update password if it's not empty (user wants to change it)
                const passwordValue = document.getElementById('userPassword').value;
                if (passwordValue && passwordValue.trim() !== '') {
                    userData.password = passwordValue;
                }

                // SỬA: Only update signature if a new one was uploaded
                if (signaturePath) {
                    userData.signature = signaturePath;
                }

                let result;
                if (editingUserId) {
                    // Update existing user via API
                    result = await updateUserViaAPI(editingUserId, userData);
                } else {
                    // Create new user via API
                    result = await createUserViaAPI(userData);

                    // REMOVED: Automatic dog creation for new trainers
                    // Dogs should be created manually through the dog management interface
                }

                if (result.success) {
                    // Refresh data from API
                    await loadUserList();
                    await loadDogList();
                    await forceRefreshAllTrainerDropdowns();

                    // SỬA QUAN TRỌNG: FORCE CLOSE MODAL NGAY LẬP TỨC
                    setTimeout(() => {
                        forceCloseUserModal();
                    }, 100);

                    // SỬA: TRIGGER refresh web app nếu đang mở NGAY LẬP TỨC
                    triggerWebAppRefreshImmediately();

                    alert('Người dùng đã được lưu thành công!');
                } else {
                    alert(`Lỗi: ${result.error}`);
                }

            } catch (error) {
                console.error('❌ Error in submitUserForm:', error);
                alert('Có lỗi xảy ra khi lưu người dùng!');
            }

            return false;
        }

        async function deleteUser(userId) {
            if (confirm('Bạn có chắc muốn xóa người dùng này?')) {
                try {
                    const result = await deleteUserViaAPI(userId);

                    if (result.success) {
                        await loadUserList();
                        await forceRefreshAllTrainerDropdowns();
                        triggerWebAppRefreshImmediately();
                        alert('Người dùng đã được xóa!');
                    } else {
                        alert(`Lỗi: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Có lỗi xảy ra khi xóa người dùng!');
                }
            }
        }

        async function loadUserList() {
            const container = document.getElementById('userListContainer');

            // Refresh users from API
            try {
                const apiUsers = await fetchUsersFromAPI();
                if (apiUsers.length > 0) {
                    users = apiUsers;
                }
            } catch (error) {
                // console.log('Failed to refresh users from API, using cached data');
            }

            if (users.length === 0) {
                container.innerHTML = '<p>Chưa có người dùng nào.</p>';
                return;
            }

            let html = `
<table class="data-table">
<thead>
<tr>
<th>Tên</th>
<th>Username</th>
<th>Email</th>
<th>Số điện thoại</th>
<th>Phòng ban</th>
<th>Vai trò</th>
<th>Chó phân công</th>
<th>Chữ ký</th>
<th>Trạng thái</th>
<th>Hành động</th>
</tr>
</thead>
<tbody>
`;

            users.forEach(user => {
                // Get assigned dogs for this user (should already be in the user object from API)
                const assignedDogs = user.assignedDogs || [];
                const assignedDogsText = assignedDogs.length > 0 ? assignedDogs.join(', ') : 'Chưa có';

                html += `
<tr>
<td>${user.name}</td>
<td>${user.username}</td>
<td>${user.email || '<em>Chưa có</em>'}</td>
<td>${user.phone || '<em>Chưa có</em>'}</td>
<td>${user.department || '<em>Chưa có</em>'}</td>
<td><span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span></td>
<td>${assignedDogsText}</td>
<td>${user.signature ? `<img src="signatures/${user.signature}" alt="Chữ ký" style="width: 60px; height: 30px; object-fit: contain; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline'"><span style="display:none; color: #999; font-size: 11px;">File không tồn tại</span>` : '<em>Chưa có</em>'}</td>
<td><span class="status-indicator status-${user.status.toLowerCase()}">${user.status}</span></td>
<td>
<button class="btn btn-warning" onclick="editUser(${user.id})" style="margin-right: 5px;">Sửa</button>
<button class="btn btn-danger" onclick="deleteUser(${user.id})">Xóa</button>
</td>
</tr>
`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function getUserAssignedDogs(userId) {
            try {
                // Get assigned dogs from API
                const response = await fetch(`${API_BASE_URL}/api/users/${userId}/dogs`);
                const result = await response.json();
                if (result.success) {
                    return result.data.map(dog => dog.name);
                } else {
                    console.error('Failed to fetch assigned dogs:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching assigned dogs from API:', error);
                return [];
            }
        }

        // SỬA: function loadTrainerOptions để FORCE REFRESH REAL-TIME từ users data MỚI NHẤT
        async function loadTrainerOptions() {
            const select = document.getElementById('dogTrainer');
            if (!select) return; // Exit if not found

            select.innerHTML = '<option value="">Đang tải...</option>';

            try {
                // Refresh users from API to get latest trainer data
                const apiUsers = await fetchUsersFromAPI();
                if (apiUsers.length > 0) {
                    users = apiUsers;
                }

                select.innerHTML = '<option value="">Chưa phân công</option>';

                // Lấy DISTINCT trainers (không duplicate)
                const trainers = users.filter(u => u.role === 'TRAINER');
                const uniqueTrainers = trainers.filter((trainer, index, arr) =>
                    arr.findIndex(t => t.id === trainer.id) === index
                );

                uniqueTrainers.forEach(trainer => {
                    const option = document.createElement('option');
                    option.value = trainer.id;
                    option.textContent = `${trainer.name} (${trainer.username})`;
                    option.dataset.trainerName = trainer.name;
                    select.appendChild(option);
                });

                console.log(`✅ FORCE REFRESHED trainer dropdown with ${uniqueTrainers.length} trainers`);
            } catch (error) {
                console.error('Error loading trainer options:', error);
                select.innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
            }
        }

        // SỬA: THÊM function để FORCE REFRESH TẤT CẢ trainer dropdown NGAY LẬP TỨC
        async function forceRefreshAllTrainerDropdowns() {
            // Refresh trainer dropdown trong dog modal nếu đang mở
            const dogModal = document.getElementById('dogModal');
            if (dogModal && dogModal.style.display !== 'none') {
                await loadTrainerOptions();
            }

            // Trigger refresh cho tất cả page khác nếu cần
            console.log('✅ All trainer dropdowns force refreshed immediately');
        }

        // SỬA: THÊM function updateTrainerInfo
        function updateTrainerInfo() {
            const trainerSelect = document.getElementById('dogTrainer');
            const selectedOption = trainerSelect.options[trainerSelect.selectedIndex];
            const hlvTenInput = document.getElementById('hlvTen');

            if (selectedOption && selectedOption.value) {
                hlvTenInput.value = selectedOption.dataset.trainerName || selectedOption.textContent.split(' (')[0];
            } else {
                hlvTenInput.value = '';
            }
        }

        // SỬA: openCreateDogModal với clear full form + FORCE REFRESH TRAINER DROPDOWN
        async function openCreateDogModal() {
            editingDogId = null;
            document.getElementById('dogModalTitle').textContent = 'Thêm Chó Nghiệp Vụ Mới';

            // Clear all form fields
            document.getElementById('dogName').value = '';
            document.getElementById('dogChipId').value = '';
            document.getElementById('dogBirthDate').value = '';
            document.getElementById('dogBirthPlace').value = '';
            document.getElementById('dogBreed').value = '';
            document.getElementById('dogGender').value = '';
            document.getElementById('dogFeatures').value = '';
            document.getElementById('dogFurColor').value = '';
            document.getElementById('dogValue').value = '';
            document.getElementById('dogFatherName').value = '';
            document.getElementById('dogFatherBirth').value = '';
            document.getElementById('dogFatherPlace').value = '';
            document.getElementById('dogFatherBreed').value = '';
            document.getElementById('dogFatherFeatures').value = '';
            document.getElementById('dogTrainer').value = '';
            document.getElementById('dogStatus').value = 'ACTIVE';

            // SỬA: Clear trainer info
            document.getElementById('hlvTen').value = '';
            document.getElementById('hlvNgaysinh').value = '';
            document.getElementById('hlvCapbac').value = '';
            document.getElementById('hlvChucvu').value = '';
            document.getElementById('hlvDonvi').value = '';
            document.getElementById('hlvDaotao').value = '';

            // SỬA: FORCE Load trainers mới nhất mỗi lần mở modal
            await loadTrainerOptions();

            document.getElementById('dogModal').style.display = 'block';
        }

        // SỬA: editDog với full form data
        async function editDog(dogId) {
            const dog = dogs.find(d => d.id === dogId);
            if (dog) {
                editingDogId = dogId;
                document.getElementById('dogModalTitle').textContent = 'Chỉnh Sửa Chó Nghiệp Vụ';

                // Load full data from database
                document.getElementById('dogName').value = dog.name || '';
                document.getElementById('dogChipId').value = dog.chip_id || dog.chipId || '';
                document.getElementById('dogBirthDate').value = dog.birth_date || dog.birthDate || '';
                document.getElementById('dogBirthPlace').value = dog.birth_place || dog.birthPlace || '';
                document.getElementById('dogBreed').value = dog.breed || '';
                document.getElementById('dogGender').value = dog.gender || '';
                document.getElementById('dogFeatures').value = dog.features || '';
                document.getElementById('dogFurColor').value = dog.fur_color || dog.furColor || '';
                document.getElementById('dogValue').value = dog.value || '';
                document.getElementById('dogFatherName').value = dog.father_name || dog.fatherName || '';
                document.getElementById('dogFatherBirth').value = dog.father_birth || dog.fatherBirth || '';
                document.getElementById('dogFatherPlace').value = dog.father_place || dog.fatherPlace || '';
                document.getElementById('dogFatherBreed').value = dog.father_breed || dog.fatherBreed || '';
                document.getElementById('dogFatherFeatures').value = dog.father_features || dog.fatherFeatures || '';
                document.getElementById('dogStatus').value = dog.status || 'ACTIVE';

                // SỬA: Load trainer info - handle both field name formats
                document.getElementById('hlvTen').value = dog.hlv_ten || dog.hlvTen || '';
                document.getElementById('hlvNgaysinh').value = dog.hlv_ngaysinh || dog.hlvNgaysinh || '';
                document.getElementById('hlvCapbac').value = dog.hlv_capbac || dog.hlvCapbac || '';
                document.getElementById('hlvChucvu').value = dog.hlv_chucvu || dog.hlvChucvu || '';
                document.getElementById('hlvDonvi').value = dog.hlv_donvi || dog.hlvDonvi || '';
                document.getElementById('hlvDaotao').value = dog.hlv_daotao || dog.hlvDaotao || '';

                // SỬA: FORCE REFRESH trainer options trước khi set value
                await loadTrainerOptions();
                const trainerId = dog.trainer_id || dog.trainerId;
                document.getElementById('dogTrainer').value = trainerId || '';

                document.getElementById('dogModal').style.display = 'block';
            }
        }

        // SỬA: submitDogForm với event handling
        async function submitDogForm(event) {
            event.preventDefault();
            event.stopPropagation();

            try {
                const dogData = {
                    name: document.getElementById('dogName').value,
                    chip_id: document.getElementById('dogChipId').value,
                    birth_date: document.getElementById('dogBirthDate').value,
                    birth_place: document.getElementById('dogBirthPlace').value,
                    breed: document.getElementById('dogBreed').value,
                    gender: document.getElementById('dogGender').value,
                    features: document.getElementById('dogFeatures').value,
                    fur_color: document.getElementById('dogFurColor').value,
                    value: document.getElementById('dogValue').value,
                    father_name: document.getElementById('dogFatherName').value,
                    father_birth: document.getElementById('dogFatherBirth').value,
                    father_place: document.getElementById('dogFatherPlace').value,
                    father_breed: document.getElementById('dogFatherBreed').value,
                    father_features: document.getElementById('dogFatherFeatures').value,
                    trainer_id: parseInt(document.getElementById('dogTrainer').value) || null,
                    status: document.getElementById('dogStatus').value,
                    // SỬA: Thêm trainer info
                    hlv_ten: document.getElementById('hlvTen').value,
                    hlv_ngaysinh: document.getElementById('hlvNgaysinh').value,
                    hlv_capbac: document.getElementById('hlvCapbac').value,
                    hlv_chucvu: document.getElementById('hlvChucvu').value,
                    hlv_donvi: document.getElementById('hlvDonvi').value,
                    hlv_daotao: document.getElementById('hlvDaotao').value
                };

                let result;
                if (editingDogId) {
                    // Update existing dog via API
                    result = await updateDogViaAPI(editingDogId, dogData);
                } else {
                    // Create new dog via API
                    result = await createDogViaAPI(dogData);
                }

                if (result.success) {
                    // SỬA: LƯU VÀO PROFILE SYSTEM GIỐNG WEB
                    const profileData = {
                        name: dogData.name,
                        sohieu: dogData.chip_id,
                        ngaysinh: dogData.birth_date,
                        noisinh: dogData.birth_place,
                        giong: dogData.breed,
                        tinhbiet: dogData.gender,
                        dacdiem: dogData.features,
                        maulong: dogData.fur_color,
                        giatri: dogData.value,
                        dongho_ba: dogData.father_name,
                        dongho_ngaysinh: dogData.father_birth,
                        dongho_noisinh: dogData.father_place,
                        dongho_giong: dogData.father_breed,
                        dongho_dacdiem: dogData.father_features,
                        hlv_ten: dogData.hlv_ten,
                        hlv_ngaysinh: dogData.hlv_ngaysinh,
                        hlv_capbac: dogData.hlv_capbac,
                        hlv_chucvu: dogData.hlv_chucvu,
                        hlv_donvi: dogData.hlv_donvi,
                        hlv_daotao: dogData.hlv_daotao
                    };

                    // TODO: Save to database

                    closeModal('dogModal');
                    await loadDogList();

                    // SỬA: TRIGGER refresh web app menu nếu đang mở NGAY LẬP TỨC
                    triggerWebAppRefreshImmediately();

                    alert('Chó nghiệp vụ đã được lưu thành công với đầy đủ thông tin!');
                } else {
                    alert(`Lỗi: ${result.error}`);
                }

            } catch (error) {
                console.error('Error in submitDogForm:', error);
                alert('Có lỗi xảy ra khi lưu chó nghiệp vụ!');
            }
        }

        async function deleteDog(dogId) {
            if (confirm('Bạn có chắc muốn xóa chó nghiệp vụ này?')) {
                try {
                    const result = await deleteDogViaAPI(dogId);

                    if (result.success) {
                        await loadDogList();
                        triggerWebAppRefreshImmediately();
                        alert('Chó nghiệp vụ đã được xóa!');
                    } else {
                        alert(`Lỗi: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting dog:', error);
                    alert('Có lỗi xảy ra khi xóa chó nghiệp vụ!');
                }
            }
        }

        async function loadDogList() {
            const container = document.getElementById('dogListContainer');

            // Refresh both dogs and users from API to get latest trainer assignments
            try {
                const [apiDogs, apiUsers] = await Promise.all([
                    fetchDogsFromAPI(),
                    fetchUsersFromAPI()
                ]);
                
                if (apiDogs.length > 0) {
                    dogs = apiDogs;
                }
                if (apiUsers.length > 0) {
                    users = apiUsers;
                }
            } catch (error) {
                console.error('Failed to refresh data from API:', error);
            }

            if (dogs.length === 0) {
                container.innerHTML = '<p>Chưa có chó nghiệp vụ nào.</p>';
                return;
            }

            let html = `
<table class="data-table">
<thead>
<tr>
<th>Tên CNV</th>
<th>Số Chip</th>
<th>Giống</th>
<th>HLV</th>
<th>Trạng thái</th>
<th>Hành động</th>
</tr>
</thead>
<tbody>
`;

            dogs.forEach(dog => {
                // Handle both trainer_id and trainerId for compatibility
                const trainerId = dog.trainer_id || dog.trainerId;
                const trainer = trainerId ? users.find(u => u.id === trainerId) : null;
                const statusClass = dog.status.toLowerCase().replace(' ', '-');
                const chipId = dog.chip_id || dog.chipId;

                html += `
<tr>
<td><strong>${dog.name}</strong></td>
<td>${chipId}</td>
<td>${dog.breed}</td>
<td>${trainer ? trainer.name : '<em>Chưa phân công</em>'}</td>
<td><span class="status-indicator status-${statusClass}">${dog.status}</span></td>
<td>
<button class="btn btn-info" onclick="viewDogJournals('${dog.name}')" style="margin-right: 5px; font-size: 12px; padding: 4px 8px;">Xem</button>
<button class="btn btn-warning" onclick="editDog(${dog.id})" style="margin-right: 5px; font-size: 12px; padding: 4px 8px;">Sửa</button>
<button class="btn btn-danger" onclick="deleteDog(${dog.id})" style="font-size: 12px; padding: 4px 8px;">Xóa</button>
</td>
</tr>
`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Function to view all training journals for a specific dog
        async function viewDogJournals(dogName) {
            try {
                console.log('🔍 Loading journals for dog:', dogName);
                
                // Fetch journals from database API
                const response = await fetch(`${API_BASE_URL}/api/journals`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch journals');
                }
                
                const allJournals = result.data || [];
                
                // Filter journals for this specific dog
                const dogJournals = allJournals.filter(journal => 
                    journal.dog_name === dogName
                );
                
                if (dogJournals.length === 0) {
                    alert(`Chó ${dogName} chưa có nhật ký huấn luyện nào.`);
                    return;
                }
                
                // Sort by date (newest first)
                dogJournals.sort((a, b) => new Date(b.journal_date) - new Date(a.journal_date));
                
                // Create dropdown options with detailed information
                let journalOptions = '<option value="">Chọn nhật ký để xem</option>';
                
                dogJournals.forEach(journal => {
                    // Get trainer name
                    const trainerName = journal.trainer_name || 'Chưa xác định';
                    
                    // Get approval status
                    let approvalStatus = 'Chưa duyệt';
                    if (journal.approval_status === 'APPROVED') {
                        approvalStatus = '✅ Đã duyệt';
                    } else if (journal.approval_status === 'REJECTED') {
                        approvalStatus = '❌ Bị từ chối';
                    } else {
                        approvalStatus = '⏳ Chờ duyệt';
                    }
                    
                    // Get health status
                    const healthStatus = journal.health_status || 'Không có thông tin';
                    
                    // Get training activities count
                    let trainingCount = 0;
                    if (journal.training_activities) {
                        try {
                            const trainingData = JSON.parse(journal.training_activities);
                            trainingCount = trainingData.length || 0;
                        } catch (e) {
                            trainingCount = 0;
                        }
                    }
                    
                    // Create display text with detailed information
                    const displayText = `${formatDateToDDMMYYYY(journal.journal_date)} | ${trainerName} | ${approvalStatus} | Sức khỏe: ${healthStatus} | ${trainingCount} hoạt động`;
                    
                    journalOptions += `<option value="${journal.journal_date}|${dogName}|${journal.id}" title="${displayText}">${displayText}</option>`;
                });
                
                // Create modal with dropdown (similar to viewOldJournals)
                const modalHtml = `
                    <div id="dogJournalsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 95%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin-top: 0; color: #333;">📋 XEM NHẬT KÝ HUẤN LUYỆN - ${dogName}</h3>
                            <p style="color: #666; margin-bottom: 20px;">Tìm thấy <strong>${dogJournals.length}</strong> nhật ký. Chọn nhật ký để xem bản PDF A4:</p>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">📅 Chọn nhật ký:</label>
                                <select id="dogJournalSelect" style="width: 100%; padding: 12px; margin: 5px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    ${journalOptions}
                                </select>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007bff;">
                                <h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ℹ️ Thông tin hiển thị:</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 13px;">
                                    <li><strong>Ngày:</strong> Ngày của nhật ký</li>
                                    <li><strong>Huấn luyện viên:</strong> Người phụ trách</li>
                                    <li><strong>Trạng thái:</strong> Đã duyệt/Chờ duyệt/Bị từ chối</li>
                                    <li><strong>Sức khỏe:</strong> Tình trạng sức khỏe của chó</li>
                                    <li><strong>Hoạt động:</strong> Số lượng hoạt động huấn luyện</li>
                                </ul>
                            </div>
                            
                            <div style="text-align: right; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
                                <button onclick="closeDogJournalsModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; margin-right: 10px; cursor: pointer; font-size: 14px; transition: background 0.3s;">Hủy</button>
                                <button onclick="viewSelectedDogJournal()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s;">📄 Xem PDF A4</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Initialize Select2 on the dropdown after modal is added to DOM
                setTimeout(() => {
                    const selectElement = document.getElementById('dogJournalSelect');
                    if (selectElement && typeof $ !== 'undefined' && $.fn.select2) {
                        console.log('Initializing Select2 on dogJournalSelect');
                        $(selectElement).select2({
                            placeholder: 'Chọn nhật ký để xem',
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $('#dogJournalsModal'),
                            language: {
                                noResults: function() {
                                    return 'Không tìm thấy nhật ký nào';
                                },
                                searching: function() {
                                    return 'Đang tìm kiếm...';
                                }
                            },
                            templateResult: function(data) {
                                if (!data.id) {
                                    return data.text;
                                }
                                
                                // Simple template without custom styling to avoid conflicts
                                return data.text;
                            },
                            templateSelection: function(data) {
                                return data.text;
                            }
                        });
                        console.log('Select2 initialized successfully');
                    } else {
                        console.error('Select2 initialization failed:', {
                            selectElement: !!selectElement,
                            jquery: typeof $ !== 'undefined',
                            select2: typeof $ !== 'undefined' && $.fn.select2
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('Error loading dog journals:', error);
                alert('Có lỗi xảy ra khi tải nhật ký: ' + error.message);
            }
        }
        
        // Helper function to close the dog journals modal
        function closeDogJournalsModal() {
            const modal = document.getElementById('dogJournalsModal');
            if (modal) {
                // Destroy Select2 instance before removing modal
                const selectElement = document.getElementById('dogJournalSelect');
                if (selectElement && typeof $ !== 'undefined' && $.fn.select2 && $(selectElement).hasClass('select2-hidden-accessible')) {
                    console.log('Destroying Select2 instance');
                    $(selectElement).select2('destroy');
                }
                
                modal.remove();
            }
        }
        
        // Function to view selected journal from dropdown
        function viewSelectedDogJournal() {
            const selectedValue = document.getElementById('dogJournalSelect').value;
            
            if (!selectedValue) {
                alert('Vui lòng chọn nhật ký để xem!');
                return;
            }
            
            try {
                const [date, dogName, journalId] = selectedValue.split('|');
                
                // Close the modal first
                closeDogJournalsModal();
                
                // Open the journal in the main web application
                const journalKey = `journal_${dogName}_${date}_${journalId}`;
                const url = `index.html?journalKey=${encodeURIComponent(journalKey)}&view=journal`;
                
                // Open in new tab to preserve dashboard state
                const newWindow = window.open(url, '_blank');
                
                if (!newWindow) {
                    // If popup blocked, show alert with instructions
                    alert(`Để xem nhật ký chi tiết, vui lòng:\n1. Cho phép popup cho trang này\n2. Hoặc copy link sau và mở trong tab mới:\n${url}`);
                }
            } catch (error) {
                console.error('Error viewing selected journal:', error);
                alert('Có lỗi xảy ra khi xem nhật ký: ' + error.message);
            }
        }

        // Journal Management Functions - DATABASE API ONLY
        async function loadJournalList() {
            console.log('🔍 loadJournalList() called');
            const container = document.getElementById('journalListContainer');
            console.log('📦 Container element:', container);
            
            if (!container) {
                console.error('❌ journalListContainer element not found!');
                return;
            }

            try {
                console.log('🌐 Fetching from:', `${API_BASE_URL}/api/journals`);
                // Fetch journals from database API
                const response = await fetch(`${API_BASE_URL}/api/journals`);
                console.log('📡 Response status:', response.status);
                const result = await response.json();
                console.log('📊 API result:', result);

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch journals');
                }

                const journals = result.data || [];
                console.log('📋 Journals count:', journals.length);

                if (journals.length === 0) {
                    container.innerHTML = '<p>Chưa có nhật ký nào.</p>';
                    console.log('❌ No journals found');
                    return;
                }

                // Sort by date (newest first)
                journals.sort((a, b) => new Date(b.journal_date) - new Date(a.journal_date));

                let html = `
<table class="data-table">
<thead>
<tr>
<th>Ngày</th>
<th>CNV</th>
<th>HLV</th>
<th>Trạng thái</th>
<th>Chữ ký</th>
<th>Hành động</th>
</tr>
</thead>
<tbody>
`;

                journals.forEach(journal => {
                    const hasHvlSignature = parseSignatureStatus(journal.hlv_signature);
                    const hasLeaderSignature = parseSignatureStatus(journal.leader_signature);
                    const statusClass = journal.approval_status === 'APPROVED' ? 'status-active' :
                        journal.approval_status === 'REJECTED' ? 'status-inactive' : 'status-pending';
                    const statusText = journal.approval_status === 'APPROVED' ? 'Đã duyệt' :
                        journal.approval_status === 'REJECTED' ? 'Từ chối' : 'Chờ duyệt';

                    html += `
<tr>
<td>${formatDateToDDMMYYYY(journal.journal_date)}</td>
<td><strong>${journal.dog_name}</strong></td>
<td>${journal.trainer_name}</td>
<td><span class="status-indicator ${statusClass}">${statusText}</span></td>
<td>HLV: ${hasHvlSignature} | LD: ${hasLeaderSignature}</td>
<td>
<button class="btn btn-info" onclick="viewJournalFromDashboard(${journal.id})" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Xem</button>
${journal.approval_status !== 'APPROVED' ? `<button class="btn btn-success" onclick="approveJournalFromDashboard(${journal.id})" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Duyệt</button>` : ''}
<button class="btn btn-danger" onclick="deleteJournalFromDashboard(${journal.id})" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Xóa</button>
</td>
</tr>
`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                console.log('✅ Successfully loaded and displayed', journals.length, 'journals');

            } catch (error) {
                console.error('❌ Error loading journals from database:', error);
                container.innerHTML = '<p style="color: red;">❌ Không thể tải nhật ký từ cơ sở dữ liệu. Vui lòng kiểm tra kết nối server.</p>';
            }
        }

        async function loadPendingJournals() {
            const container = document.getElementById('journalListContainer');

            try {
                // Fetch pending journals from database API
                const response = await fetch(`${API_BASE_URL}/api/journals/pending`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch pending journals');
                }

                const journals = result.data || [];

                if (journals.length === 0) {
                    container.innerHTML = '<p>Không có nhật ký nào chờ duyệt.</p>';
                    return;
                }

                // Sort by date (newest first)
                journals.sort((a, b) => new Date(b.journal_date) - new Date(a.journal_date));

                let html = `<h4>📋 Nhật ký chờ duyệt (${journals.length})</h4>`;
                html += `
                    <table class="data-table">
                    <thead>
                    <tr>
                    <th>Ngày</th>
                    <th>CNV</th>
                    <th>HLV</th>
                    <th>Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                `;

                journals.forEach(journal => {
                    html += `
                        <tr>
<td>${formatDateToDDMMYYYY(journal.journal_date)}</td>
<td><strong>${journal.dog_name}</strong></td>
<td>${journal.trainer_name}</td>
<td>
<button class="btn btn-info" onclick="viewJournalFromDashboard(${journal.id})" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Xem</button>
<button class="btn btn-success" onclick="approveJournalFromDashboard(${journal.id})" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Duyệt</button>
                        </td>
                        </tr>
                        `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                // console.log(`✅ Loaded ${journals.length} pending journals from database`);

            } catch (error) {
                console.error('Error loading pending journals from database:', error);
                container.innerHTML = '<p style="color: red;">❌ Không thể tải nhật ký chờ duyệt từ cơ sở dữ liệu.</p>';
            }
        }

        async function loadApprovedJournals() {
            const container = document.getElementById('journalListContainer');

            try {
                // Fetch approved journals from database API
                const response = await fetch(`${API_BASE_URL}/api/journals/approved`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch approved journals');
                }

                const journals = result.data || [];

                if (journals.length === 0) {
                    container.innerHTML = '<p>Chưa có nhật ký nào được duyệt.</p>';
                    return;
                }

                // Sort by date (newest first)
                journals.sort((a, b) => new Date(b.journal_date) - new Date(a.journal_date));

                let html = `<h4>✅ Nhật ký đã duyệt (${journals.length})</h4>`;
                html += `
                <table class="data-table">
                <thead>
                <tr>
                <th>Ngày</th>
                <th>CNV</th>
                <th>HLV</th>
                <th>Ngày duyệt</th>
                <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
            `;

                journals.forEach(journal => {
                    html += `
                    <tr>
<td>${formatDateToDDMMYYYY(journal.journal_date)}</td>
<td><strong>${journal.dog_name}</strong></td>
<td>${journal.trainer_name}</td>
<td>${journal.approved_at ? formatDateToDDMMYYYY(journal.approved_at) : 'N/A'}</td>
<td>
<button class="btn btn-info" onclick="viewJournalFromDashboard(${journal.id})" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Xem</button>
                    </td>
                    </tr>
                `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;

                // console.log(`✅ Loaded ${journals.length} approved journals from database`);

            } catch (error) {
                console.error('Error loading approved journals from database:', error);
                container.innerHTML = '<p style="color: red;">❌ Không thể tải nhật ký đã duyệt từ cơ sở dữ liệu.</p>';
            }
        }

        // SỬA: Function viewJournalFromDashboard - NOW USES DATABASE
        async function viewJournalFromDashboard(journalId) {
            try {
                console.log('🔍 viewJournalFromDashboard called with journalId:', journalId);
                
                // Fetch journal details from database
                const response = await fetch(`${API_BASE_URL}/api/journals/${journalId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Journal not found');
                }

                const journal = result.data;
                console.log('📋 Journal data:', journal);

                // Open web app with journal parameter - use the same approach as showPureA4JournalView
                const dogName = journal.dog_name || 'Unknown';
                const journalDate = journal.journal_date || new Date().toISOString().split('T')[0];
                
                // Open web app with proper parameters for showPureA4JournalView
                const url = `index.html?dogName=${encodeURIComponent(dogName)}&date=${encodeURIComponent(journalDate)}&journalId=${journalId}&view=journal`;
                window.open(url, '_blank', 'width=1200,height=800');

                console.log(`✅ Opening journal ${journalId} (${dogName}) in new tab`);

            } catch (error) {
                console.error('Error viewing journal from database:', error);
                alert('Có lỗi xảy ra khi xem nhật ký: ' + error.message);
            }
        }

        // SỬA: Function approveJournalFromDashboard - NOW USES DATABASE
        async function approveJournalFromDashboard(journalId) {
            if (confirm('Bạn có chắc muốn duyệt nhật ký này?')) {
                try {
                    const approverId = currentDashboardUser ? currentDashboardUser.id : 1; // Default to admin if no user

                    const response = await fetch(`${API_BASE_URL}/api/journals/${journalId}/approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            approver_id: approverId,
                            approved: true,
                            rejection_reason: null
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Nhật ký đã được duyệt thành công!');
                        loadJournalList(); // Refresh list
                        // console.log('✅ Journal approved successfully');
                    } else {
                        throw new Error(result.error || 'Failed to approve journal');
                    }

                } catch (error) {
                    console.error('Error approving journal:', error);
                    alert('Có lỗi xảy ra khi duyệt nhật ký: ' + error.message);
                }
            }
        }

        // SỬA: Function deleteJournalFromDashboard - NOW USES DATABASE
        async function deleteJournalFromDashboard(journalId) {
            if (confirm('Bạn có chắc muốn xóa nhật ký này? Hành động này không thể hoàn tác.')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/journals/${journalId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Nhật ký đã được xóa thành công!');
                        loadJournalList(); // Refresh list
                        // console.log('✅ Journal deleted successfully');
                    } else {
                        throw new Error(result.error || 'Failed to delete journal');
                    }

                } catch (error) {
                    console.error('Error deleting journal:', error);
                    alert('Có lỗi xảy ra khi xóa nhật ký: ' + error.message);
                }
            }
        }

        // Helper function to convert database journal to frontend format
        function convertDatabaseJournalToFrontend(dbJournal) {
            return {
                generalInfo: {
                    dogName: dbJournal.dog_name,
                    date: dbJournal.journal_date,
                    hlv: dbJournal.trainer_name
                },
                trainingBlocks: dbJournal.training_activities ?
                    dbJournal.training_activities.split(';').map(activity => ({ content: activity.trim() })) : [],
                operationBlocks: dbJournal.operation_activities ?
                    dbJournal.operation_activities.split(';').map(activity => ({ content: activity.trim() })) : [],
                care: convertCareActivitiesToLocalStorage(dbJournal.care_activities),
                health: {
                    status: dbJournal.health_status || 'Tốt',
                    weather: dbJournal.weather_conditions || ''
                },
                hlvComment: dbJournal.behavior_notes || '',
                otherIssues: dbJournal.challenges || '',
                approval: {
                    status: dbJournal.approval_status,
                    leaderStatus: dbJournal.approval_status === 'APPROVED' ? 'Đã duyệt' :
                        dbJournal.approval_status === 'REJECTED' ? 'Từ chối' : 'Chờ duyệt',
                    leaderComment: dbJournal.rejection_reason || '',
                    approvedBy: dbJournal.approver_name || '',
                    approvedAt: dbJournal.approved_at || ''
                },
                lastModified: dbJournal.updated_at || dbJournal.created_at
            };
        }

        // Helper function to parse signature data
        function parseSignatureStatus(signatureData) {
            if (!signatureData) return '❌';
            
            try {
                const parsed = JSON.parse(signatureData);
                if (parsed && parsed.name && typeof parsed.name === 'string' && parsed.name.trim() !== '') {
                    return '✅';
                }
            } catch (e) {
                // If parsing fails, check if it's a non-empty string
                if (signatureData && typeof signatureData === 'string' && signatureData.trim() !== '') {
                    return '✅';
                }
            }
            return '❌';
        }

        // Helper function to convert care activities
        function convertCareActivitiesToLocalStorage(careActivities) {
            const care = { morning: '', afternoon: '', evening: '' };

            if (careActivities) {
                const activities = careActivities.split(';').filter(a => a.trim());

                activities.forEach(activity => {
                    if (activity.includes('Sáng:')) {
                        care.morning = activity.replace('Sáng:', '').trim();
                    } else if (activity.includes('Chiều:')) {
                        care.afternoon = activity.replace('Chiều:', '').trim();
                    } else if (activity.includes('Tối:')) {
                        care.evening = activity.replace('Tối:', '').trim();
                    }
                });
            }

            return care;
        }

        // TODO: Function to load journals from database
        function loadJournalListFromDatabase() {
            const container = document.getElementById('journalListContainer');

            const allJournals = [];

            // TODO: Get journals from database
            // console.log('TODO: Load journals from database');

            if (allJournals.length === 0) {
                container.innerHTML = '<p>Chưa có nhật ký nào.</p>';
                return;
            }

            // Sắp xếp theo ngày mới nhất
            allJournals.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = `
<table class="data-table">
<thead>
<tr>
<th>Ngày</th>
<th>CNV</th>
<th>HLV</th>
<th>Trạng thái</th>
<th>Chữ ký</th>
<th>Hành động</th>
</tr>
</thead>
<tbody>
`;

            allJournals.forEach(journal => {
                const hasHvlSignature = (journal.data && journal.data.approval && journal.data.approval
                    .hvlSignature) ? '✅' : '❌';
                const hasLeaderSignature = (journal.data && journal.data.approval && journal.data.approval
                    .leaderSignature) ? '✅' : '❌';
                const statusClass = (journal.approvalStatus && journal.approvalStatus.includes('Đã duyệt')) ?
                    'status-active' :
                    'status-pending';

                html += `
<tr>
<td>${formatDateToDDMMYYYY(journal.date)}</td>
<td><strong>${journal.dogName}</strong></td>
<td>${journal.trainer}</td>
<td><span class="status-indicator ${statusClass}">${journal.approvalStatus}</span></td>
<td>HLV: ${hasHvlSignature} | LD: ${hasLeaderSignature}</td>
<td>
<button class="btn btn-info" onclick="viewJournalFromDashboard('${journal.key}')" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Xem</button>
${!(journal.approvalStatus && journal.approvalStatus.includes('Đã duyệt')) ? `<button class="btn btn-success" onclick="approveJournalFromDashboard('${journal.key}')" style="font-size: 11px; padding: 3px 8px; margin: 1px;">Duyệt</button>` : ''}
</td>
</tr>
`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // console.log(`✅ Loaded ${allJournals.length} journals from database`);
        }

        // Web Control Functions
        function openWebForRole(role) {
            const user = getUserByRole(role);

            if (user) {
                const params = new URLSearchParams({
                    user: encodeURIComponent(user.name),
                    role: role,
                    dogs: user.assignedDogs.join(',')
                });

                const url = `index.html?${params.toString()}`;
                window.open(url, '_blank', 'width=1200,height=800');
            } else {
                alert(`Không tìm thấy người dùng với vai trò ${role}!`);
            }
        }

        function getUserByRole(role) {
            if (role === 'ADMIN') {
                return users.find(u => u.role === 'ADMIN') || currentDashboardUser;
            } else if (role === 'TRAINER') {
                return users.find(u => u.role === 'TRAINER') || {
                    name: 'Demo Trainer',
                    role: 'TRAINER',
                    assignedDogs: ['CNV BI']
                };
            } else if (role === 'MANAGER') {
                return users.find(u => u.role === 'MANAGER') || {
                    name: 'Demo Manager',
                    role: 'MANAGER',
                    assignedDogs: ['CNV BI', 'CNV LU', 'CNV RËCH', 'CNV KY', 'CNV REX']
                };
            }
            return null;
        }

        // Assignment Functions
        function loadAssignmentList() {
            const container = document.getElementById('userListContainer');

            let html = '<h4>📋 Phân công chó nghiệp vụ</h4>';
            const trainers = users.filter(u => u.role === 'TRAINER');

            if (trainers.length === 0) {
                container.innerHTML = html + '<p>Chưa có huấn luyện viên nào.</p>';
                return;
            }

            html += `
                <table class="data-table">
                <thead>
                <tr>
                <th>Huấn luyện viên</th>
                <th>Chó được phân công</th>
                <th>Số lượng</th>
                <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
            `;

            trainers.forEach(trainer => {
                html += `
                    <tr>
                    <td>${trainer.name}</td>
                    <td>${trainer.assignedDogs.join(', ') || 'Chưa có'}</td>
                    <td>${trainer.assignedDogs.length}</td>
                    <td>
                    <button class="btn btn-warning" onclick="editUser(${trainer.id})">Chỉnh sửa</button>
                    </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function viewDogStatus() {
            const container = document.getElementById('dogListContainer');

            let html = '<h4>📊 Thống kê trạng thái chó nghiệp vụ</h4>';

            const statusCount = {
                ACTIVE: dogs.filter(d => d.status === 'ACTIVE').length,
                TRAINING: dogs.filter(d => d.status === 'TRAINING').length,
                INACTIVE: dogs.filter(d => d.status === 'INACTIVE').length
            };

            html += `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: #4CAF50; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h3>${statusCount.ACTIVE}</h3>
                <p>Đang hoạt động</p>
                </div>
                <div style="background: #FF9800; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h3>${statusCount.TRAINING}</h3>
                <p>Đang huấn luyện</p>
                </div>
                <div style="background: #f44336; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h3>${statusCount.INACTIVE}</h3>
                <p>Nghỉ ngơi</p>
                </div>
                </div>
                `;

            // Show unassigned dogs
            const unassignedDogs = dogs.filter(d => !d.trainerId);

            if (unassignedDogs.length > 0) {
                html += '<h5>🔄 Chó chưa được phân công:</h5>';
                html += '<ul>';
                unassignedDogs.forEach(dog => {
                    html += `<li>${dog.name} (${dog.breed}) - ${dog.status}</li>`;
                });
                html += '</ul>';
            }

            container.innerHTML = html;
        }

        // SỬA: Thêm function trigger refresh web app NGAY LẬP TỨC VÀ MẠNH MẼ
        function triggerWebAppRefreshImmediately() {
            // FORCE IMMEDIATE refresh cho tất cả web app tabs đang mở
            try {
                // TODO: Use database events for refresh signals
                // console.log('TODO: Implement database refresh signals');

                // console.log('✅ FORCE TRIGGERED immediate web app refresh with multiple signals');
            } catch (e) {
                // console.log('Error triggering web app refresh:', e);
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    if (modal.id === 'userModal') {
                        forceCloseUserModal();
                    } else {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // SỬA: THÊM AUTO-REFRESH LISTENERS cho dashboard + FORCE REFRESH TRAINER DROPDOWN

        // Listen for postMessage from web app
        window.addEventListener('message', function (event) {
            if (event.data && event.data.type === 'JOURNAL_UPDATE') {
                // console.log('✅ Received journal update from web app:', event.data.journalKey);
                // Refresh journal list immediately
                if (document.getElementById('journalListContainer').innerHTML !== '') {
                    loadJournalList();
                }
                // Show notification
                showNotification('Nhật ký mới đã được cập nhật!', 'success');
            }
        });

        // TODO: Listen for database changes
        window.addEventListener('storage', function (e) {
            if (e.key === 'dashboard_journal_refresh') {
                // console.log('✅ Journal refresh triggered via database');
                loadJournalList();
            }
        });

        // SỬA: Force refresh on tab focus + REFRESH TRAINER DROPDOWN
        window.addEventListener('focus', async () => {
            loadJournalList();
            loadUserList();
            loadDogList();
            loadTrainingDataTable();

            // SỬA: FORCE Refresh trainer dropdown khi focus dashboard
            const dogModal = document.getElementById('dogModal');
            if (dogModal && dogModal.style.display !== 'none') {
                await loadTrainerOptions();
                console.log('✅ Force refreshed trainer dropdown on dashboard focus');
            }
        });

        // AUTO-REFRESH JOURNAL LIST EVERY 5 SECONDS để real-time
        setInterval(() => {
            if (document.getElementById('journalListContainer').innerHTML !== '' &&
                !document.getElementById('journalListContainer').innerHTML.includes('Chưa có nhật ký')) {
                loadJournalList();
            }
        }, 5000);

        // Training Data Management Functions
        function calculateTrainingHoursFromActivities(operationActivities) {
            if (!operationActivities || !operationActivities.trim()) {
                return 0;
            }
            
            let totalHours = 0;
            
            try {
                // Parse operation activities - could be JSON or text format
                let activities = [];
                
                // Try to parse as JSON first
                try {
                    activities = JSON.parse(operationActivities);
                } catch (e) {
                    // If not JSON, try to parse as semicolon-separated text
                    activities = operationActivities.split(';').map(activity => activity.trim()).filter(activity => activity);
                }
                
                // Process each activity
                activities.forEach(activity => {
                    if (typeof activity === 'string') {
                        // Look for time patterns in the text - use matchAll to avoid regex state issues
                        const timePattern = /(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/g;
                        const matches = [...activity.matchAll(timePattern)];
                        
                        matches.forEach(match => {
                            const fromHour = parseInt(match[1]);
                            const fromMinute = parseInt(match[2]);
                            const toHour = parseInt(match[3]);
                            const toMinute = parseInt(match[4]);
                            
                            // Calculate duration in hours
                            const fromTime = fromHour + (fromMinute / 60);
                            const toTime = toHour + (toMinute / 60);
                            const duration = toTime - fromTime;
                            
                            if (duration > 0) {
                                totalHours += duration;
                            }
                        });
                    } else if (typeof activity === 'object' && activity !== null) {
                        // Handle object format with fromTime and toTime properties
                        if (activity.fromTime && activity.toTime) {
                            const fromTime = parseTimeToHours(activity.fromTime);
                            const toTime = parseTimeToHours(activity.toTime);
                            const duration = toTime - fromTime;
                            
                            if (duration > 0) {
                                totalHours += duration;
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error parsing operation activities:', error);
            }
            
            return totalHours;
        }
        
        function parseTimeToHours(timeString) {
            if (!timeString) return 0;
            
            // Handle various time formats: "08:30", "8:30", "08:30:00"
            const timeMatch = timeString.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
            if (timeMatch) {
                const hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);
                return hours + (minutes / 60);
            }
            
            return 0;
        }

        async function loadTrainingDataTable() {
            const container = document.getElementById('trainingDataContainer');
            if (!container) {
                console.error('❌ trainingDataContainer element not found!');
                return;
            }

            try {
                // Show loading state
                container.innerHTML = '<p>Đang tải dữ liệu huấn luyện...</p>';

                // Fetch dogs and training journals from API
                const [dogsResponse, journalsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/dogs`),
                    fetch(`${API_BASE_URL}/api/journals`)
                ]);

                const dogsResult = await dogsResponse.json();
                const journalsResult = await journalsResponse.json();

                if (!dogsResult.success || !journalsResult.success) {
                    throw new Error('Failed to fetch data from API');
                }

                const dogs = dogsResult.data || [];
                const journals = journalsResult.data || [];

                // Generate training data table
                generateTrainingDataTable(dogs, journals, container);

            } catch (error) {
                console.error('❌ Error loading training data:', error);
                container.innerHTML = '<p style="color: red;">❌ Không thể tải dữ liệu huấn luyện. Vui lòng kiểm tra kết nối server.</p>';
            }
        }

        function generateTrainingDataTable(dogs, journals, container) {
            // Group journals by dog and month
            const dogMonthData = {};
            
            // Remove duplicate journals (same id) to prevent double counting
            const uniqueJournals = journals.filter((journal, index, self) => 
                index === self.findIndex(j => j.id === journal.id)
            );
            
            // Filter out journals with empty training data (training_activities, care_activities, operation_activities)
            const journalsWithData = uniqueJournals.filter(journal => {
                const hasTrainingData = journal.training_activities && typeof journal.training_activities === 'string' && journal.training_activities.trim() !== '';
                const hasCareData = journal.care_activities && typeof journal.care_activities === 'string' && journal.care_activities.trim() !== '';
                const hasOperationData = journal.operation_activities && typeof journal.operation_activities === 'string' && journal.operation_activities.trim() !== '';
                
                // Only include journals that have at least one type of data
                return hasTrainingData || hasCareData || hasOperationData;
            });
            
            console.log('🔍 DEBUG - Original journals count:', journals.length);
            console.log('🔍 DEBUG - Unique journals count:', uniqueJournals.length);
            console.log('🔍 DEBUG - Journals with data count:', journalsWithData.length);
            
            journalsWithData.forEach(journal => {
                const dogName = journal.dog_name;
                const journalDate = new Date(journal.journal_date);
                const month = journalDate.getMonth() + 1; // 1-12
                const year = journalDate.getFullYear();
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                
                if (!dogMonthData[dogName]) {
                    dogMonthData[dogName] = {};
                }
                
                if (!dogMonthData[dogName][monthKey]) {
                    dogMonthData[dogName][monthKey] = {
                        month: month,
                        trainingDays: new Set(),
                        trainingHours: 0,
                        operationDays: new Set(),
                        operationResults: [],
                        careActivities: [],
                        healthStatus: [],
                        journalDates: new Set()
                    };
                }
                
                const data = dogMonthData[dogName][monthKey];
                
                // Add journal date to unique dates
                data.journalDates.add(journal.journal_date);
                
                // Count training days - each journal entry counts as a training day
                data.trainingDays.add(journal.journal_date);
                
                // Calculate training hours from fromTime to toTime in operation_activities
                if (journal.operation_activities && typeof journal.operation_activities === 'string' && journal.operation_activities.trim()) {
                    const trainingHours = calculateTrainingHoursFromActivities(journal.operation_activities);
                    data.trainingHours += trainingHours;
                }
                
                // Count operation days and results
                if (journal.operation_activities && typeof journal.operation_activities === 'string' && journal.operation_activities.trim()) {
                    data.operationDays.add(journal.journal_date);
                    data.operationResults.push(journal.operation_activities);
                }
                
                // Collect care activities and health status
                if (journal.care_activities && typeof journal.care_activities === 'string' && journal.care_activities.trim()) {
                    data.careActivities.push(journal.care_activities);
                }
                
                if (journal.health_status && typeof journal.health_status === 'string' && journal.health_status.trim()) {
                    data.healthStatus.push(journal.health_status);
                }
            });

            // Only show current month data
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            const currentMonthKey = `${currentYear}-${currentMonth.toString().padStart(2, '0')}`;
            
            const sortedMonths = [currentMonthKey];

            // Generate HTML table
            let html = `
                <div style="overflow-x: auto; margin-top: 15px;">
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align: middle; background: #667eea; color: white; text-align: center;">Chó Nghiệp Vụ</th>
                                <th colspan="2" style="background: #4CAF50; color: white; text-align: center;">Huấn luyện</th>
                                <th colspan="2" style="background: #FF9800; color: white; text-align: center;">Tác nghiệp</th>
                                <th colspan="2" style="background: #2196F3; color: white; text-align: center;">Chăm sóc</th>
                                <th rowspan="2" style="vertical-align: middle; background: #667eea; color: white; text-align: center;">Tháng</th>
                            </tr>
                            <tr>
                                <th style="background: #4CAF50; color: white; text-align: center;">Số ngày HL</th>
                                <th style="background: #4CAF50; color: white; text-align: center;">Số giờ HL</th>
                                <th style="background: #FF9800; color: white; text-align: center;">Số ngày tác nghiệp</th>
                                <th style="background: #FF9800; color: white; text-align: center;">Kết quả tác nghiệp</th>
                                <th style="background: #2196F3; color: white; text-align: center;">Lịch thăm khám</th>
                                <th style="background: #2196F3; color: white; text-align: center;">Sức khỏe CNV</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Generate rows for each month, showing ALL dogs for that month
            sortedMonths.forEach(monthKey => {
                const monthNumber = parseInt(monthKey.split('-')[1]);
                const monthName = `Tháng ${monthNumber}`;
                
                // Show ALL dogs for this month, regardless of whether they have data
                dogs.forEach((dog, index) => {
                    const monthData = dogMonthData[dog.name] && dogMonthData[dog.name][monthKey] 
                        ? dogMonthData[dog.name][monthKey] 
                        : null;
                    
                    // Calculate data for this dog and month
                    const trainingDays = monthData ? monthData.trainingDays.size : 0;
                    const trainingHours = monthData ? Math.round(monthData.trainingHours * 10) / 10 : 0;
                    const operationDays = monthData ? monthData.operationDays.size : 0;
                    const operationResults = monthData && monthData.operationDays.size > 0 ? getOperationResultsDisplay(monthData) : '-';
                    const careSchedule = monthData && monthData.journalDates.size > 0 ? 
                        Array.from(monthData.journalDates).sort().map(date => formatDateToDDMMYYYY(date)).join(', ') : '-';
                    const healthStatus = monthData && monthData.healthStatus.length > 0 ? 
                        getMostCommonHealthStatus(monthData.healthStatus) : '-';
                    
                    const isFirstRow = index === 0;
                    html += `
                        <tr>
                            <td class="dog-name"><strong>${dog.name}</strong></td>
                            <td class="training-days">${trainingDays > 0 ? trainingDays : '-'}</td>
                            <td class="training-hours">${trainingHours > 0 ? trainingHours + 'h' : '-'}</td>
                            <td class="operation-days">${operationDays > 0 ? operationDays : '-'}</td>
                            <td class="operation-results">${operationResults}</td>
                            <td class="care-schedule">${careSchedule}</td>
                            <td class="health-status">
                                ${healthStatus !== '-' ? 
                                    `<span class="status-indicator ${getHealthStatusClass(healthStatus)}">${healthStatus}</span>` : 
                                    '-'
                                }
                            </td>
                            <td class="month" ${isFirstRow ? `rowspan="${dogs.length}"` : ''}>
                                ${isFirstRow ? `<strong>${monthName}</strong>` : ''}
                            </td>
                        </tr>
                    `;
                });
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // Only show summary if there's actual data to display
            if (journalsWithData.length > 0) {
                html += `
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <h4>📈 Tổng kết:</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <h3 style="color: #4CAF50;">${dogs.length}</h3>
                            <p>Tổng số CNV</p>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <h3 style="color: #FF9800;">${sortedMonths.length}</h3>
                            <p>Tháng có dữ liệu</p>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <h3 style="color: #2196F3;">${journalsWithData.length}</h3>
                            <p>Tổng nhật ký có dữ liệu</p>
                        </div>
                        <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                            <h3 style="color: #9C27B0;">${Math.round(journalsWithData.reduce((sum, j) => sum + calculateTrainingHoursFromActivities(j.operation_activities), 0) * 10) / 10}h</h3>
                            <p>Tổng giờ huấn luyện</p>
                        </div>
                    </div>
                </div>
                `;
            } else {
                html += `
                <div style="margin-top: 15px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; text-align: center;">
                    <h4 style="color: #856404; margin: 0;">⚠️ Không có dữ liệu huấn luyện</h4>
                    <p style="color: #856404; margin: 10px 0 0 0;">Chưa có nhật ký nào với dữ liệu huấn luyện, chăm sóc hoặc tác nghiệp trong tháng hiện tại.</p>
                </div>
                `;
            }

            container.innerHTML = html;
            console.log('✅ Dog-month summary table generated successfully');
        }

        function getMostCommonHealthStatus(healthStatuses) {
            if (healthStatuses.length === 0) return 'Chưa có';
            
            const counts = {};
            healthStatuses.forEach(status => {
                counts[status] = (counts[status] || 0) + 1;
            });
            
            return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        }

        function getOperationResultsDisplay(monthData) {
            // For now, return a simple display since we need to analyze the operation data
            // This could be enhanced to show specific operation results from the journal data
            const hasOperations = monthData.operationDays && monthData.operationDays.size > 0;
            return hasOperations ? 'Có hoạt động' : '-';
        }

        function getHealthStatusClass(healthStatus) {
            switch (healthStatus) {
                case 'Tốt': return 'status-active';
                case 'Khá': return 'status-active';
                case 'Trung bình': return 'status-pending';
                case 'Kém': return 'status-inactive';
                default: return 'status-pending';
            }
        }

        function exportTrainingDataToPDF() {
            const container = document.getElementById('trainingDataContainer');
            if (!container || !container.innerHTML.includes('table')) {
                alert('Vui lòng tải báo cáo trước khi xuất PDF!');
                return;
            }

            try {
                // Create a new window for PDF generation
                const printWindow = window.open('', '_blank');
                
                // Get current date for filename
                const currentDate = new Date();
                const dateString = formatDateToDDMMYYYY(currentDate).replace(/\//g, '-');
                
                // Create PDF content using string concatenation
                let pdfContent = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
                pdfContent += '<title>Báo Cáo Huấn Luyện và Tác Nghiệp - ' + dateString + '</title>';
                pdfContent += '<style>';
                pdfContent += 'body { font-family: Arial, sans-serif; margin: 20px; color: #333; }';
                pdfContent += '.header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }';
                pdfContent += '.header h1 { color: #667eea; margin: 0; font-size: 24px; }';
                pdfContent += '.header p { margin: 5px 0; color: #666; }';
                pdfContent += 'table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 8px; table-layout: fixed; }';
                pdfContent += 'th, td { border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; word-wrap: break-word; overflow: hidden; }';
                pdfContent += 'th { background-color: #667eea; color: white; font-weight: bold; font-size: 8px; }';
                pdfContent += '.dog-name { width: 15%; }';
                pdfContent += '.training-days { width: 7%; }';
                pdfContent += '.training-hours { width: 7%; }';
                pdfContent += '.operation-days { width: 3.5%; }';
                pdfContent += '.operation-results { width: 6%; }';
                pdfContent += '.care-schedule { width: 15%; }';
                pdfContent += '.health-status { width: 8%; }';
                pdfContent += '.month { width: 8%; }';
                pdfContent += '.training-header { background-color: #4CAF50 !important; }';
                pdfContent += '.operation-header { background-color: #FF9800 !important; }';
                pdfContent += '.care-header { background-color: #2196F3 !important; }';
                pdfContent += 'tbody td { text-align: center !important; }';
                pdfContent += 'tbody td * { text-align: center !important; }';
                pdfContent += 'tbody td strong { text-align: center !important; }';
                pdfContent += 'tbody td span { text-align: center !important; }';
                pdfContent += '@media print { body { margin: 5px; } .no-print { display: none; } table { font-size: 7px; width: 100%; } th, td { padding: 1px; font-size: 7px; } .header h1 { font-size: 16px; } .header p { font-size: 9px; } @page { size: A4 landscape; margin: 0.5cm; } }';
                pdfContent += '</style></head><body>';
                
                pdfContent += '<div class="header">';
                pdfContent += '<h1>🐕 BÁO CÁO HUẤN LUYỆN VÀ TÁC NGHIỆP</h1>';
                pdfContent += '<p>Hệ Thống Quản Lý Chó Nghiệp Vụ Hải Quan</p>';
                pdfContent += '<p>Ngày xuất báo cáo: ' + formatDateToDDMMYYYY(currentDate) + '</p>';
                pdfContent += '</div>';
                
                // Create custom table for PDF with exactly 8 columns
                let tableHtml = '<table>';
                tableHtml += '<thead>';
                tableHtml += '<tr>';
                tableHtml += '<th rowspan="2" class="dog-name">Chó Nghiệp Vụ</th>';
                tableHtml += '<th colspan="2" class="training-header">Huấn luyện</th>';
                tableHtml += '<th colspan="2" class="operation-header">Tác nghiệp</th>';
                tableHtml += '<th colspan="2" class="care-header">Chăm sóc</th>';
                tableHtml += '<th rowspan="2" class="month">Tháng</th>';
                tableHtml += '</tr>';
                tableHtml += '<tr>';
                tableHtml += '<th class="training-days">Số ngày HL</th>';
                tableHtml += '<th class="training-hours">Số giờ HL</th>';
                tableHtml += '<th class="operation-days">Số ngày tác nghiệp</th>';
                tableHtml += '<th class="operation-results">Kết quả tác nghiệp</th>';
                tableHtml += '<th class="care-schedule">Lịch thăm khám</th>';
                tableHtml += '<th class="health-status">Sức khỏe CNV</th>';
                tableHtml += '</tr>';
                tableHtml += '</thead>';
                tableHtml += '<tbody>';
                
                // Manually create table rows to ensure exactly 8 columns
                const tableElement = container.querySelector('table tbody');
                if (tableElement) {
                    const rows = tableElement.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 8) {
                            // Only include rows with exactly 8 columns
                            tableHtml += '<tr>';
                            cells.forEach(cell => {
                                const className = cell.className || '';
                                const content = cell.innerHTML;
                                tableHtml += '<td class="' + className + '">' + content + '</td>';
                            });
                            tableHtml += '</tr>';
                        }
                    });
                }
                
                tableHtml += '</tbody>';
                tableHtml += '</table>';
                
                pdfContent += tableHtml;
                
                // Add landscape orientation instruction
                pdfContent += '<div class="no-print" style="text-align: center; margin-top: 20px; padding: 15px; background: #e3f2fd; border: 2px solid #2196F3; border-radius: 8px;">';
                pdfContent += '<h3 style="margin: 0; color: #1976D2;">📄 Hướng dẫn in PDF</h3>';
                pdfContent += '<p style="margin: 10px 0; color: #1976D2; font-weight: bold;">1. Nhấn nút "In PDF" bên dưới</p>';
                pdfContent += '<p style="margin: 10px 0; color: #1976D2; font-weight: bold;">2. Trong cửa sổ in, chọn "Landscape" (Ngang)</p>';
                pdfContent += '<p style="margin: 10px 0; color: #1976D2; font-weight: bold;">3. Đảm bảo "More settings" → "Margins" → "Minimum"</p>';
                pdfContent += '</div>';
                pdfContent += '<div class="no-print" style="text-align: center; margin-top: 10px;">';
                pdfContent += '<button onclick="window.print()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">🖨️ In PDF</button>';
                pdfContent += '<button onclick="window.close()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-left: 10px;">❌ Đóng</button>';
                pdfContent += '</div>';
                
                pdfContent += '</body></html>';
                
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                
                showNotification('Đang tạo file PDF...', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Có lỗi xảy ra khi tạo PDF! Vui lòng thử lại.');
            }
        }

        function refreshTrainingData() {
            loadTrainingDataTable();
            showNotification('Dữ liệu huấn luyện đã được làm mới!', 'success');
        }

        // SỬA: Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.dashboard-notification').forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `dashboard-notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                animation: slideIn 0.3s ease;
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(function() {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(function() { notification.remove(); }, 300);
            }, 3000);
        }
    </script>
</body>

</html>