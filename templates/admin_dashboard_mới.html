<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
        }
        .header {
            background: #4a5568;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header.admin { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .header.manager { background: linear-gradient(135deg, #dd6b20, #c05621); }
        .header.trainer { background: linear-gradient(135deg, #38a169, #2f855a); }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card.admin { border-left: 4px solid #e53e3e; }
        .stat-card.manager { border-left: 4px solid #dd6b20; }
        .stat-card.trainer { border-left: 4px solid #38a169; }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .table th {
            background: #f7fafc;
            font-weight: bold;
        }
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .badge-admin { background: #fed7d7; color: #c53030; }
        .badge-manager { background: #feebc8; color: #dd6b20; }
        .badge-trainer { background: #c6f6d5; color: #38a169; }
        .badge-active { background: #c6f6d5; color: #38a169; }
        .badge-warning { background: #fef5e7; color: #d69e2e; }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn-primary { background: #4299e1; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .alert-info { background: #bee3f8; color: #2c5282; border-left: 4px solid #3182ce; }
        .alert-success { background: #c6f6d5; color: #22543d; border-left: 4px solid #38a169; }
        .alert-warning { background: #fef5e7; color: #744210; border-left: 4px solid #d69e2e; }
        .alert-error { background: #fed7d7; color: #742a2a; border-left: 4px solid #e53e3e; }
        .my-dog-card {
            background: linear-gradient(135deg, #68d391, #38a169);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .my-dog-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }
        .hidden { display: none !important; }

        /* MODAL STYLES - THEO PHOM CHUẨN */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            border-radius: 12px;
            padding: 0;
            width: 98%;
            max-width: 1400px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
            color: white;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
            color: white;
            padding: 2rem;
            border-radius: 12px 12px 0 0;
            text-align: center;
            position: relative;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }
        .modal-body {
            padding: 2.5rem;
            background: white;
            color: #333;
            margin: 0;
        }
        
        /* FORM SECTIONS - 3 CỘT NGANG */
        .form-sections-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            min-height: 500px;
        }
        .form-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }
        .section-header {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .photo-section {
            display: flex;
            align-items: flex-start;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .photo-upload {
            flex-shrink: 0;
        }
        .photo-circle {
            width: 140px;
            height: 140px;
            border: 3px dashed #cbd5e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin: 0 auto;
        }
        .photo-circle:hover {
            border-color: #4299e1;
            background: #f7fafc;
        }
        .photo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .photo-placeholder {
            text-align: center;
            color: #a0aec0;
            font-size: 0.875rem;
        }
        .info-fields {
            flex: 1;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }
        .form-input {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 1.05rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            background: white;
        }
        .form-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .form-input.error {
            border-color: #e53e3e;
        }
        .form-select {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 1.05rem;
            background: white;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        .form-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .form-textarea {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 1.05rem;
            resize: vertical;
            min-height: 90px;
            font-family: Arial, sans-serif;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            background: white;
        }
        .form-textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .form-error {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        .modal-footer {
            padding: 2rem 2.5rem;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }
        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 1rem 0;
                max-width: none;
            }
            .modal-body {
                padding: 1.5rem;
            }
            .form-sections-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .form-section {
                padding: 1.5rem;
            }
            .modal-footer {
                flex-direction: column;
                padding: 1.5rem;
            }
        }
        @media (max-width: 1400px) {
            .form-sections-container {
                grid-template-columns: 1fr 1fr;
            }
            .form-section:nth-child(3) {
                grid-column: 1 / -1;
            }
        }
        @media (min-width: 1401px) {
            .modal-content {
                max-width: 1600px;
            }
        }
    </style>
</head>
<body>
    <div class="header" id="header">
        <h1 id="dashboard-title">🐕 Dashboard</h1>
        <div>
            <span>Xin chào, <span id="user-name">User</span> (<span id="user-role">ROLE</span>)</span>
            <a href="/" class="btn btn-primary">🏠 Trang chính</a>
            <button onclick="logout()" class="btn btn-danger">🚪 Đăng xuất</button>
        </div>
    </div>

    <div class="container">
        <!-- Role Alert -->
        <div id="role-alert" class="alert alert-info">
            <strong id="alert-text">Đang tải...</strong>
        </div>

        <!-- Success/Error Messages -->
        <div id="message-container"></div>

        <!-- Statistics -->
        <div class="stats" id="stats-container">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- TRAINER: MY DOG -->
        <div id="trainer-section" class="hidden">
            <div class="section">
                <h2 class="section-title">🐕 Chó được gán cho tôi</h2>
                
                <div class="my-dog-card">
                    <h3>Max - German Shepherd</h3>
                    <p><strong>Tuổi:</strong> 3 tuổi | <strong>Chuyên môn:</strong> Drug Detection</p>
                    <p><strong>Trình độ:</strong> Advanced | <strong>Trạng thái:</strong> Active</p>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="writeJournal(1)">✏️ Viết nhật ký hôm nay</button>
                        <button class="btn btn-primary" onclick="viewHistory(1)">📋 Xem lịch sử</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DOGS SECTION -->
        <div id="dogs-section" class="hidden">
            <div class="section">
                <div class="section-title">
                    🐕 Danh sách chó nghiệp vụ
                    <button id="add-dog-btn" class="btn btn-success hidden" onclick="openAddDogModal()">➕ Thêm chó mới</button>
                </div>
                
                <div id="dogs-table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tên chó</th>
                                <th>Giống</th>
                                <th>Tuổi</th>
                                <th>Chuyên môn</th>
                                <th>Trainer</th>
                                <th>Trạng thái</th>
                                <th id="action-header" class="hidden">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="dogs-table-body">
                            <!-- Will be populated by loadDogs() -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- USERS SECTION -->
        <div id="users-section" class="hidden">
            <div class="section">
                <div class="section-title">
                    👥 Quản lý người dùng
                    <button class="btn btn-success" onclick="addUser()">➕ Thêm người dùng</button>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th>Tên đăng nhập</th>
                            <th>Họ và tên</th>
                            <th>Vai trò</th>
                            <th>Đơn vị</th>
                            <th>Chó được gán</th>
                            <th>Ngày tạo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>admin</strong></td>
                            <td>Quan tri vien he thong</td>
                            <td><span class="badge badge-admin">ADMIN</span></td>
                            <td>IT</td>
                            <td><span>Chưa gán</span></td>
                            <td>05/08/2025</td>
                        </tr>
                        <tr>
                            <td><strong>manager1</strong></td>
                            <td>Tran Thi Huong</td>
                            <td><span class="badge badge-manager">MANAGER</span></td>
                            <td>Cua khau Mong Cai</td>
                            <td><span>Chưa gán</span></td>
                            <td>05/08/2025</td>
                        </tr>
                        <tr>
                            <td><strong>trainer1</strong></td>
                            <td>John Trainer</td>
                            <td><span class="badge badge-trainer">TRAINER</span></td>
                            <td>Training Unit</td>
                            <td><span class="badge badge-active">Max</span></td>
                            <td>05/08/2025</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- JOURNALS SECTION -->
        <div class="section">
            <div class="section-title">
                <span id="journal-title">📝 Nhật ký</span>
            </div>
            <p><em>Chức năng nhật ký sẽ được phát triển trong Phase 2C</em></p>
        </div>
    </div>

    <!-- DOG MODAL - SỬ DỤNG CHO CẢ ADD VÀ EDIT -->
    <div id="dogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Sổ tay chó nghiệp vụ</h2>
                <button class="modal-close" onclick="closeDogModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="dogForm" onsubmit="submitDogForm(event)">
                    
                    <div class="form-sections-container">
                        
                        <!-- CỘT 1: THÔNG TIN CNV -->
                        <div class="form-section">
                            <div class="section-header">
                                <span>🐕 THÔNG TIN CNV</span>
                            </div>
                            
                            <!-- Ảnh CNV -->
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <div class="photo-circle" onclick="document.getElementById('dogPhoto').click()">
                                    <div class="photo-placeholder">
                                        <div style="font-size: 2rem;">📷</div>
                                        <div>Ảnh CNV</div>
                                    </div>
                                </div>
                                <input type="file" id="dogPhoto" accept="image/*" style="display: none;" onchange="previewPhoto(this)">
                            </div>
                            
                            <!-- Thông tin CNV -->
                            <div class="form-group">
                                <label class="form-label">1. Tên CNV: *</label>
                                <input type="text" id="dogName" class="form-input" placeholder="VD: Bi, Lu, Rex..." required>
                                <div class="form-error" id="dogNameError">Vui lòng nhập tên CNV</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">2. Số hiệu: *</label>
                                <input type="text" id="dogNumber" class="form-input" placeholder="VD: CNV001..." required>
                                <div class="form-error" id="dogNumberError">Vui lòng nhập số hiệu CNV</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">3. Ngày sinh: *</label>
                                <input type="date" id="birthDate" class="form-input" required>
                                <div class="form-error" id="birthDateError">Vui lòng chọn ngày sinh</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">4. Nơi sinh: *</label>
                                <input type="text" id="birthPlace" class="form-input" placeholder="VD: Hà Nội..." required>
                                <div class="form-error" id="birthPlaceError">Vui lòng nhập nơi sinh</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">5. Giống CNV: *</label>
                                <select id="breed" class="form-select" required>
                                    <option value="">-- Chọn giống --</option>
                                    <option value="German Shepherd">German Shepherd</option>
                                    <option value="Belgian Malinois">Belgian Malinois</option>
                                    <option value="Labrador Retriever">Labrador Retriever</option>
                                    <option value="Golden Retriever">Golden Retriever</option>
                                    <option value="Border Collie">Border Collie</option>
                                    <option value="Rottweiler">Rottweiler</option>
                                    <option value="Doberman">Doberman</option>
                                    <option value="Dutch Shepherd">Dutch Shepherd</option>
                                    <option value="Khác">Khác</option>
                                </select>
                                <div class="form-error" id="breedError">Vui lòng chọn giống CNV</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">6. Tính biệt: *</label>
                                <select id="gender" class="form-select" required>
                                    <option value="">-- Chọn tính biệt --</option>
                                    <option value="Đực">Đực</option>
                                    <option value="Cái">Cái</option>
                                </select>
                                <div class="form-error" id="genderError">Vui lòng chọn tính biệt</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">8. Màu lông: *</label>
                                <input type="text" id="color" class="form-input" placeholder="VD: Đen vàng..." required>
                                <div class="form-error" id="colorError">Vui lòng nhập màu lông</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">9. Số giá trị:</label>
                                <input type="number" id="valueScore" class="form-input" min="1" max="10" placeholder="1-10">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">7. Đặc điểm ngoại hình:</label>
                                <textarea id="physicalDescription" class="form-textarea" placeholder="Mô tả đặc điểm..." style="height: 80px;"></textarea>
                            </div>
                        </div>

                        <!-- CỘT 2: DÒNG HỌ -->
                        <div class="form-section">
                            <div class="section-header">
                                <span>👨‍👩‍👧‍👦 DÒNG HỌ</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">1. Tên bố:</label>
                                <input type="text" id="fatherName" class="form-input" placeholder="Tên CNV bố">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">2. Ngày sinh bố:</label>
                                <input type="date" id="fatherBirthDate" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">3. Nơi sinh bố:</label>
                                <input type="text" id="fatherBirthPlace" class="form-input" placeholder="Nơi sinh CNV bố">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">4. Giống bố:</label>
                                <input type="text" id="fatherBreed" class="form-input" placeholder="Giống CNV bố">
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">5. Đặc điểm ngoại hình bố:</label>
                                <textarea id="fatherDescription" class="form-textarea" placeholder="Mô tả đặc điểm ngoại hình CNV bố..." style="height: 120px; resize: none;"></textarea>
                            </div>
                        </div>

                        <!-- CỘT 3: HUẤN LUYỆN VIÊN QUẢN LÝ -->
                        <div class="form-section">
                            <div class="section-header">
                                <span>👨‍🏫 HUẤN LUYỆN VIÊN QUẢN LÝ</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">1. Họ và tên HLV:</label>
                                <input type="text" id="trainerName" class="form-input" placeholder="Họ và tên huấn luyện viên">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">2. Ngày tháng năm sinh HLV:</label>
                                <input type="date" id="trainerBirthDate" class="form-input">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">3. Cấp bậc:</label>
                                <select id="trainerRank" class="form-select">
                                    <option value="">-- Chọn cấp bậc --</option>
                                    <option value="Thiếu úy">Thiếu úy</option>
                                    <option value="Trung úy">Trung úy</option>
                                    <option value="Thượng úy">Thượng úy</option>
                                    <option value="Đại úy">Đại úy</option>
                                    <option value="Thiếu tá">Thiếu tá</option>
                                    <option value="Trung tá">Trung tá</option>
                                    <option value="Thượng tá">Thượng tá</option>
                                    <option value="Đại tá">Đại tá</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">4. Chức vụ:</label>
                                <input type="text" id="trainerPosition" class="form-input" placeholder="VD: Huấn luyện viên...">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">5. Đơn vị:</label>
                                <input type="text" id="trainerUnit" class="form-input" placeholder="Tên đơn vị công tác">
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">6. Quá trình đào tạo:</label>
                                <textarea id="trainerTraining" class="form-textarea" placeholder="Quá trình đào tạo CNV..." style="height: 120px; resize: none;"></textarea>
                            </div>
                        </div>
                        
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="closeDogModal()">❌ Hủy</button>
                <button type="submit" form="dogForm" class="btn btn-success" id="submitBtn">
                    <span class="loading" id="submitLoading">
                        <div class="spinner"></div>
                        <span id="loadingText">Đang lưu...</span>
                    </span>
                    <span id="submitText">💾 Lưu hồ sơ</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDogs = [];
        let editingDogId = null; // Track whether we're adding or editing
        const userData = {
            role: 'ADMIN',
            name: 'Admin User'
        };
        
        // Try to get real data from server
        try {
            const sessionData = '{{ session.admin_user.role if session.admin_user else "" }}';
            const sessionName = '{{ session.admin_user.full_name if session.admin_user else "" }}';
            if (sessionData) {
                userData.role = sessionData;
                userData.name = sessionName;
            }
        } catch (e) {
            console.log('Using default data');
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadDogs();
        });

        function initializeDashboard() {
            const header = document.getElementById('header');
            const dashboardTitle = document.getElementById('dashboard-title');
            const userNameEl = document.getElementById('user-name');
            const userRoleEl = document.getElementById('user-role');
            const roleAlert = document.getElementById('role-alert');
            const alertText = document.getElementById('alert-text');
            const statsContainer = document.getElementById('stats-container');
            const journalTitle = document.getElementById('journal-title');
            
            // Set user info
            userNameEl.textContent = userData.name;
            userRoleEl.textContent = userData.role;
            
            // Configure based on role
            if (userData.role === 'ADMIN') {
                setupAdmin();
            } else if (userData.role === 'MANAGER') {
                setupManager();
            } else if (userData.role === 'TRAINER') {
                setupTrainer();
            } else {
                setupAdmin(); // Default fallback
            }
        }
        
        function setupAdmin() {
            const header = document.getElementById('header');
            const dashboardTitle = document.getElementById('dashboard-title');
            const alertText = document.getElementById('alert-text');
            const statsContainer = document.getElementById('stats-container');
            const journalTitle = document.getElementById('journal-title');
            
            header.classList.add('admin');
            dashboardTitle.textContent = '🛡️ Dashboard Quản trị';
            alertText.innerHTML = '<strong>🛡️ Quyền Admin:</strong> Bạn có thể quản lý toàn bộ hệ thống.';
            
            // Stats
            statsContainer.innerHTML = `
                <div class="stat-card admin"><div class="stat-number">3</div><div>👥 Tổng người dùng</div></div>
                <div class="stat-card admin"><div class="stat-number" id="total-dogs-stat">3</div><div>🐕 Tổng chó nghiệp vụ</div></div>
                <div class="stat-card admin"><div class="stat-number">0</div><div>📝 Tổng nhật ký</div></div>
                <div class="stat-card admin"><div class="stat-number">0</div><div>⏳ Chờ duyệt</div></div>
            `;
            
            // Show sections
            showElement('dogs-section');
            showElement('users-section');
            showElement('add-dog-btn');
            showElement('action-header');
            showElements('.admin-actions');
            
            journalTitle.textContent = '⏳ Nhật ký chờ duyệt';
        }
        
        function setupManager() {
            const header = document.getElementById('header');
            const dashboardTitle = document.getElementById('dashboard-title');
            const roleAlert = document.getElementById('role-alert');
            const alertText = document.getElementById('alert-text');
            const statsContainer = document.getElementById('stats-container');
            const journalTitle = document.getElementById('journal-title');
            
            header.classList.add('manager');
            dashboardTitle.textContent = '📊 Dashboard Quản lý';
            alertText.innerHTML = '<strong>📊 Quyền Manager:</strong> Bạn có thể xem tất cả chó và duyệt nhật ký.';
            roleAlert.className = 'alert alert-warning';
            
            // Stats
            statsContainer.innerHTML = `
                <div class="stat-card manager"><div class="stat-number" id="total-dogs-stat">3</div><div>🐕 Chó nghiệp vụ</div></div>
                <div class="stat-card manager"><div class="stat-number">0</div><div>⏳ Chờ duyệt</div></div>
                <div class="stat-card manager"><div class="stat-number">2</div><div>✅ Đang hoạt động</div></div>
                <div class="stat-card manager"><div class="stat-number">1</div><div>📚 Đang huấn luyện</div></div>
            `;
            
            // Show sections
            showElement('dogs-section');
            journalTitle.textContent = '⏳ Nhật ký chờ duyệt';
        }
        
        function setupTrainer() {
            const header = document.getElementById('header');
            const dashboardTitle = document.getElementById('dashboard-title');
            const roleAlert = document.getElementById('role-alert');
            const alertText = document.getElementById('alert-text');
            const statsContainer = document.getElementById('stats-container');
            const journalTitle = document.getElementById('journal-title');
            
            header.classList.add('trainer');
            dashboardTitle.textContent = '🎯 Dashboard Huấn luyện';
            alertText.innerHTML = '<strong>🎯 Quyền Trainer:</strong> Bạn chỉ có thể xem chó được gán và ghi nhật ký.';
            roleAlert.className = 'alert alert-success';
            
            // Stats
            statsContainer.innerHTML = `
                <div class="stat-card trainer"><div class="stat-number">1</div><div>🐕 Chó được gán</div></div>
                <div class="stat-card trainer"><div class="stat-number">0</div><div>📝 Nhật ký hôm nay</div></div>
                <div class="stat-card trainer"><div class="stat-number">0</div><div>✅ Đã duyệt</div></div>
                <div class="stat-card trainer"><div class="stat-number">0</div><div>⏳ Chờ duyệt</div></div>
            `;
            
            // Show sections
            showElement('trainer-section');
            journalTitle.textContent = '📝 Nhật ký của tôi';
        }
        
        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }
        
        function showElements(selector) {
            document.querySelectorAll(selector).forEach(el => {
                el.classList.remove('hidden');
            });
        }

        // Load dogs from API
        async function loadDogs() {
            try {
                const response = await fetch('/api/dogs');
                const data = await response.json();
                
                if (data.success) {
                    currentDogs = data.dogs;
                    renderDogsTable();
                    updateStats();
                } else {
                    console.error('Failed to load dogs:', data.message);
                }
            } catch (error) {
                console.error('Error loading dogs:', error);
                // Fallback to static data
                currentDogs = [
                    {
                        id: 1, 
                        name: 'Max', 
                        breed: 'German Shepherd', 
                        age: 3, 
                        specialty: 'Drug Detection', 
                        trainer: {username: 'trainer1'}, 
                        status: 'Active',
                        chip_id: 'CNV001',
                        birth_date: '2021-03-15',
                        birth_place: 'Hà Nội',
                        gender: 'Đực',
                        color: 'Đen vàng',
                        value_score: 8,
                        notes: 'Chó thông minh, dễ huấn luyện',
                        father_name: 'Rex Sr.',
                        trainer_name: 'Nguyễn Văn A',
                        trainer_rank: 'Thiếu úy'
                    },
                    {
                        id: 2, 
                        name: 'Luna', 
                        breed: 'Belgian Malinois', 
                        age: 2, 
                        specialty: 'Explosive Detection', 
                        trainer: null, 
                        status: 'Training',
                        chip_id: 'CNV002',
                        birth_date: '2022-06-20',
                        birth_place: 'TP.HCM',
                        gender: 'Cái',
                        color: 'Nâu vàng',
                        value_score: 9,
                        notes: 'Năng động, phản ứng nhanh'
                    },
                    {
                        id: 3, 
                        name: 'Rex', 
                        breed: 'Labrador Retriever', 
                        age: 4, 
                        specialty: 'Search & Rescue', 
                        trainer: null, 
                        status: 'Active',
                        chip_id: 'CNV003',
                        birth_date: '2020-01-10',
                        birth_place: 'Đà Nẵng',
                        gender: 'Đực',
                        color: 'Vàng nhạt',
                        value_score: 7,
                        notes: 'Hiền lành, kiên nhẫn'
                    }
                ];
                renderDogsTable();
            }
        }

        function renderDogsTable() {
            console.log('Rendering dogs table with data:', currentDogs);
            const tbody = document.getElementById('dogs-table-body');
            tbody.innerHTML = '';
            
            currentDogs.forEach(dog => {
                console.log('Rendering dog:', dog.name, dog);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${dog.name}</strong></td>
                    <td>${dog.breed}</td>
                    <td>${dog.age} tuổi</td>
                    <td>${dog.specialty}</td>
                    <td>
                        ${dog.trainer ? 
                            `<span class="badge badge-trainer">${dog.trainer.username}</span>` : 
                            '<span class="badge badge-warning">Chưa gán</span>'
                        }
                    </td>
                    <td>
                        ${dog.status === 'Active' ? 
                            '<span class="badge badge-active">Hoạt động</span>' :
                            dog.status === 'Training' ?
                                '<span class="badge badge-warning">Huấn luyện</span>' :
                                `<span class="badge">${dog.status}</span>`
                        }
                    </td>
                    ${userData.role === 'ADMIN' ? `
                        <td class="admin-actions">
                            <button onclick="editDog(${dog.id})" class="btn btn-warning" style="padding: 0.25rem 0.5rem;" title="Sửa ${dog.name}">✏️</button>
                            <button onclick="assignTrainer(${dog.id})" class="btn btn-primary" style="padding: 0.25rem 0.5rem;" title="Gán trainer">👤</button>
                        </td>
                    ` : ''}
                `;
                tbody.appendChild(row);
            });
            
            console.log('Dogs table rendered successfully');
        }

        function updateStats() {
            const totalDogsElement = document.getElementById('total-dogs-stat');
            if (totalDogsElement) {
                totalDogsElement.textContent = currentDogs.length;
            }
        }

        // ==== MODAL FUNCTIONS - SỬ DỤNG CHO CẢ ADD VÀ EDIT ====

        // Open Add Dog Modal
        function openAddDogModal() {
            editingDogId = null; // Set to add mode
            document.getElementById('modalTitle').textContent = 'Sổ tay chó nghiệp vụ - THÊM MỚI';
            document.getElementById('submitText').textContent = '💾 Lưu hồ sơ';
            document.getElementById('loadingText').textContent = 'Đang lưu...';
            
            resetForm();
            document.getElementById('dogModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Open Edit Dog Modal
        async function editDog(dogId) {
            editingDogId = dogId; // Set to edit mode
            document.getElementById('modalTitle').textContent = 'Sổ tay chó nghiệp vụ - CHỈNH SỬA';
            document.getElementById('submitText').textContent = '✅ Cập nhật';
            document.getElementById('loadingText').textContent = 'Đang cập nhật...';
            
            // Reset form first
            resetForm();
            
            // Show loading state
            showMessage('info', '⏳ Đang tải thông tin chó...');
            
            try {
                // Try to load from API first
                let dogData = null;
                try {
                    const response = await fetch(`/api/dogs/${dogId}`);
                    const data = await response.json();
                    if (data.success) {
                        dogData = data.dog;
                    }
                } catch (apiError) {
                    console.log('API not available, using static data');
                }
                
                // If API fails, use static data
                if (!dogData) {
                    dogData = currentDogs.find(dog => dog.id == dogId);
                }
                
                if (!dogData) {
                    showMessage('error', '❌ Không tìm thấy thông tin chó');
                    return;
                }
                
                // Fill form with dog data
                fillFormWithDogData(dogData);
                
                // Open modal
                document.getElementById('dogModal').classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Clear loading message
                document.getElementById('message-container').innerHTML = '';
                
            } catch (error) {
                console.error('Error loading dog data:', error);
                showMessage('error', '❌ Có lỗi xảy ra khi tải thông tin chó');
            }
        }

        // Fill form with existing dog data
        function fillFormWithDogData(dogData) {
            console.log('Filling form with dog data:', dogData);
            
            // Basic info
            document.getElementById('dogName').value = dogData.name || '';
            document.getElementById('dogNumber').value = dogData.chip_id || dogData.serialNumber || '';
            
            // Handle birth date format
            let birthDateValue = '';
            if (dogData.birth_date) {
                birthDateValue = dogData.birth_date.split('T')[0]; // Remove time part if exists
            } else if (dogData.birthDate) {
                birthDateValue = dogData.birthDate.split('T')[0];
            }
            document.getElementById('birthDate').value = birthDateValue;
            
            document.getElementById('birthPlace').value = dogData.birth_place || dogData.birthPlace || '';
            document.getElementById('breed').value = dogData.breed || '';
            document.getElementById('gender').value = dogData.gender || '';
            document.getElementById('color').value = dogData.color || '';
            document.getElementById('valueScore').value = dogData.value_score || dogData.valueScore || '';
            document.getElementById('physicalDescription').value = dogData.notes || dogData.description || dogData.physicalDescription || '';
            
            // Father info
            document.getElementById('fatherName').value = dogData.father_name || dogData.fatherName || '';
            
            let fatherBirthDate = '';
            if (dogData.father_birth_date) {
                fatherBirthDate = dogData.father_birth_date.split('T')[0];
            } else if (dogData.fatherBirthDate) {
                fatherBirthDate = dogData.fatherBirthDate.split('T')[0];
            }
            document.getElementById('fatherBirthDate').value = fatherBirthDate;
            
            document.getElementById('fatherBirthPlace').value = dogData.father_birth_place || dogData.fatherBirthPlace || '';
            document.getElementById('fatherBreed').value = dogData.father_breed || dogData.fatherBreed || '';
            document.getElementById('fatherDescription').value = dogData.father_description || dogData.fatherDescription || '';
            
            // Trainer info
            document.getElementById('trainerName').value = dogData.trainer_name || dogData.trainerName || '';
            
            let trainerBirthDate = '';
            if (dogData.trainer_birth_date) {
                trainerBirthDate = dogData.trainer_birth_date.split('T')[0];
            } else if (dogData.trainerBirthDate) {
                trainerBirthDate = dogData.trainerBirthDate.split('T')[0];
            }
            document.getElementById('trainerBirthDate').value = trainerBirthDate;
            
            document.getElementById('trainerRank').value = dogData.trainer_rank || dogData.trainerRank || '';
            document.getElementById('trainerPosition').value = dogData.trainer_position || dogData.trainerPosition || '';
            document.getElementById('trainerUnit').value = dogData.trainer_unit || dogData.trainerUnit || '';
            document.getElementById('trainerTraining').value = dogData.trainer_training || dogData.trainerTraining || '';
            
            // Handle photo if available
            if (dogData.photo_url || dogData.photoUrl) {
                const photoCircle = document.querySelector('.photo-circle');
                if (photoCircle) {
                    photoCircle.innerHTML = `<img src="${dogData.photo_url || dogData.photoUrl}" alt="Ảnh CNV">`;
                }
            }
            
            console.log('Form filled successfully');
        }

        // Close modal
        function closeDogModal() {
            document.getElementById('dogModal').classList.remove('show');
            document.body.style.overflow = 'auto';
            editingDogId = null;
            resetForm();
        }

        function resetForm() {
            document.getElementById('dogForm').reset();
            // Hide all error messages
            document.querySelectorAll('.form-error').forEach(error => {
                error.style.display = 'none';
            });
            // Remove error classes
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                input.classList.remove('error');
            });
            // Reset photo placeholders
            resetPhotoPlaceholders();
        }

        function resetPhotoPlaceholders() {
            const dogPhotoCircle = document.querySelector('.photo-circle');
            if (dogPhotoCircle) {
                dogPhotoCircle.innerHTML = `
                    <div class="photo-placeholder">
                        <div style="font-size: 2rem;">📷</div>
                        <div>Ảnh CNV</div>
                    </div>
                `;
            }
        }

        // Photo preview function
        function previewPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoCircle = document.querySelector('.photo-circle');
                    if (photoCircle) {
                        photoCircle.innerHTML = `<img src="${e.target.result}" alt="Ảnh CNV">`;
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Form validation
        function validateForm() {
            let isValid = true;
            
            // Required fields for CNV info
            const requiredFields = [
                {id: 'dogName', errorId: 'dogNameError', message: 'Vui lòng nhập tên CNV'},
                {id: 'dogNumber', errorId: 'dogNumberError', message: 'Vui lòng nhập số hiệu CNV'},
                {id: 'birthDate', errorId: 'birthDateError', message: 'Vui lòng chọn ngày sinh'},
                {id: 'birthPlace', errorId: 'birthPlaceError', message: 'Vui lòng nhập nơi sinh'},
                {id: 'breed', errorId: 'breedError', message: 'Vui lòng chọn giống CNV'},
                {id: 'gender', errorId: 'genderError', message: 'Vui lòng chọn tính biệt'},
                {id: 'color', errorId: 'colorError', message: 'Vui lòng nhập màu lông'}
            ];
            
            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                const error = document.getElementById(field.errorId);
                
                if (!input.value.trim()) {
                    showFieldError(input, error, field.message);
                    isValid = false;
                } else {
                    hideFieldError(input, error);
                }
            });
            
            return isValid;
        }

        function showFieldError(input, errorElement, message) {
            input.classList.add('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideFieldError(input, errorElement) {
            input.classList.remove('error');
            errorElement.style.display = 'none';
        }

        // Submit form - handles both add and edit
        async function submitDogForm(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const submitLoading = document.getElementById('submitLoading');
            const submitText = document.getElementById('submitText');
            
            submitBtn.disabled = true;
            submitLoading.style.display = 'flex';
            submitText.style.display = 'none';
            
            try {
                // Calculate age from birth date
                const birthDate = new Date(document.getElementById('birthDate').value);
                const today = new Date();
                const age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
                
                const formData = {
                    name: document.getElementById('dogName').value.trim(),
                    chip_id: document.getElementById('dogNumber').value.trim(),
                    breed: document.getElementById('breed').value,
                    age: age,
                    gender: document.getElementById('gender').value,
                    color: document.getElementById('color').value.trim(),
                    specialty: 'Chưa xác định', // Default value
                    training_level: 'Beginner', // Default value
                    status: 'Active',
                    health_status: 'Healthy',
                    notes: document.getElementById('physicalDescription').value.trim(),
                    // Additional fields from form
                    birth_date: document.getElementById('birthDate').value,
                    birth_place: document.getElementById('birthPlace').value.trim(),
                    value_score: document.getElementById('valueScore').value || null,
                    father_name: document.getElementById('fatherName').value.trim(),
                    father_birth_date: document.getElementById('fatherBirthDate').value,
                    father_birth_place: document.getElementById('fatherBirthPlace').value.trim(),
                    father_breed: document.getElementById('fatherBreed').value.trim(),
                    father_description: document.getElementById('fatherDescription').value.trim(),
                    trainer_name: document.getElementById('trainerName').value.trim(),
                    trainer_birth_date: document.getElementById('trainerBirthDate').value,
                    trainer_rank: document.getElementById('trainerRank').value,
                    trainer_position: document.getElementById('trainerPosition').value.trim(),
                    trainer_unit: document.getElementById('trainerUnit').value.trim(),
                    trainer_training: document.getElementById('trainerTraining').value.trim()
                };
                
                let response, data;
                
                if (editingDogId) {
                    // EDIT MODE - PUT request
                    try {
                        response = await fetch(`/api/dogs/${editingDogId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });
                        data = await response.json();
                        
                        // If API succeeds, also update local data
                        if (data.success) {
                            const dogIndex = currentDogs.findIndex(dog => dog.id == editingDogId);
                            if (dogIndex !== -1) {
                                currentDogs[dogIndex] = { 
                                    ...currentDogs[dogIndex], 
                                    ...formData, 
                                    id: editingDogId,
                                    // Keep display fields
                                    specialty: formData.specialty || currentDogs[dogIndex].specialty,
                                    trainer: currentDogs[dogIndex].trainer
                                };
                            }
                        }
                    } catch (apiError) {
                        console.log('API not available, updating static data');
                        // Fallback for edit - update static data
                        const dogIndex = currentDogs.findIndex(dog => dog.id == editingDogId);
                        if (dogIndex !== -1) {
                            // Update with new data, keeping existing structure
                            currentDogs[dogIndex] = { 
                                ...currentDogs[dogIndex], 
                                ...formData, 
                                id: editingDogId,
                                // Map form fields to display fields
                                name: formData.name,
                                breed: formData.breed,
                                age: formData.age,
                                specialty: formData.specialty || currentDogs[dogIndex].specialty || 'Chưa xác định',
                                trainer: currentDogs[dogIndex].trainer, // Keep existing trainer
                                status: formData.status || currentDogs[dogIndex].status || 'Active'
                            };
                            data = { success: true, dog: currentDogs[dogIndex] };
                        } else {
                            throw new Error('Không tìm thấy chó để cập nhật');
                        }
                    }
                } else {
                    // ADD MODE - POST request
                    try {
                        response = await fetch('/api/dogs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });
                        data = await response.json();
                    } catch (apiError) {
                        // Fallback for add - add to static data
                        const newId = Math.max(...currentDogs.map(dog => dog.id)) + 1;
                        const newDog = { ...formData, id: newId, specialty: formData.specialty || 'Chưa xác định' };
                        currentDogs.push(newDog);
                        data = { success: true, dog: newDog };
                    }
                }
                
                if (data.success) {
                    if (editingDogId) {
                        showMessage('success', '✅ Đã cập nhật hồ sơ CNV thành công!');
                        console.log('Updated dog data:', currentDogs.find(d => d.id == editingDogId));
                    } else {
                        showMessage('success', '✅ Đã lưu hồ sơ CNV thành công!');
                    }
                    closeDogModal();
                    
                    // Force re-render the table with updated data
                    renderDogsTable();
                    updateStats();
                    
                    // Also try to reload from API if available (non-blocking)
                    setTimeout(() => {
                        loadDogs().catch(() => {
                            console.log('API reload failed, using updated static data');
                        });
                    }, 100);
                } else {
                    if (data.message && data.message.includes('chip_id')) {
                        showFieldError(
                            document.getElementById('dogNumber'),
                            document.getElementById('dogNumberError'),
                            'Số hiệu CNV đã tồn tại, vui lòng sử dụng số khác'
                        );
                    } else {
                        showMessage('error', '❌ Lỗi: ' + (data.message || 'Có lỗi xảy ra'));
                    }
                }
                
            } catch (error) {
                console.error('Error submitting form:', error);
                showMessage('error', '❌ Có lỗi xảy ra khi lưu hồ sơ. Vui lòng thử lại.');
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                submitLoading.style.display = 'none';
                submitText.style.display = 'inline';
            }
        }

        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            const alertClass = type === 'success' ? 'alert-success' : 
                               type === 'info' ? 'alert-info' : 'alert-error';
            
            container.innerHTML = `
                <div class="alert ${alertClass}" style="margin-bottom: 1rem;">
                    ${message}
                </div>
            `;
            
            // Auto hide after 5 seconds (except for info messages)
            if (type !== 'info') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('dogModal');
            if (event.target === modal) {
                closeDogModal();
            }
        });

        // Other functions
        function logout() {
            fetch('/api/admin/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) window.location.href = '/admin';
            });
        }

        function addUser() { alert('🚀 Phase 2B: Chức năng thêm người dùng'); }
        function assignTrainer(dogId) { alert('🚀 Phase 2A: Gán trainer cho chó ID: ' + dogId); }
        function writeJournal(dogId) { alert('🚀 Phase 2C: Viết nhật ký cho chó ID: ' + dogId); }
        function viewHistory(dogId) { alert('🚀 Phase 2C: Xem lịch sử nhật ký chó ID: ' + dogId); }

        console.log('🎯 Dashboard loaded for role: ' + userData.role);
        console.log('✅ Edit Dog feature is ready!');
        
        // Debug function - có thể gọi trong console để kiểm tra dữ liệu
        window.debugDogs = function() {
            console.log('Current dogs data:', currentDogs);
            return currentDogs;
        };
        
        window.testEdit = function() {
            console.log('Testing edit for dog ID 1...');
            editDog(1);
        };
    </script>
</body>
</html>